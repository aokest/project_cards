# 系统架构统一规划与演进方案

基于您的愿景与现有基础，我将以“**系统架构师**”视角为您制定一份分阶段演进方案。核心理念是**“数据结构化优先，逐步替换临时方案，最终实现模块化融合”**。

---

## 1. 核心架构设计 (Target Architecture)

### 1.1 数据模型层 (Data Schema) - 核心地基
我们将数据从扁平的 JSON 升级为**关系型结构**（虽然暂用 JSON 模拟，但逻辑上必须结构化）。

*   **Project (项目/商机)**: 顶层容器
    *   `id`: 唯一标识 (如 UUID 或 `CUST-PROJ`)
    *   `code`: 项目编号 (内部管理用)
    *   `contract_code`: 合同编号
    *   `customer_id`: 关联客户
    *   `team`: { sales_lead, delivery_lead, product_lead } (允许多人，数组格式)
    *   `finance`: { total_budget, cost_budget }
    *   `status`: 阶段 (线索/立项/交付/维保)

*   **SubProjectCard (子项目/卡片)**: 执行单元
    *   `id`: `Project.id` + `-S1-P01` (继承父级 ID 规则)
    *   `parent_project_id`: **外键关联** (指向 Project)
    *   `type`: (产品交付/定制开发/驻场服务)
    *   `content`: (目标/现状/周期/内容 - 现有 Card 数据)
    *   `deliverables`: [ 关联的货架清单 ID ]
    *   `budget`: (该子项目的切片预算，可缺省)

*   **ProductCatalog (货架清单)**: 基础主数据
    *   `sku_code`: SKU 编号
    *   `name`: 产品/服务名称
    *   `unit_price`: 标准单价
    *   `type`: (标准产品/人天服务)

### 1.2 系统模块划分
1.  **Project Hub (项目中心)**: `projects.html` (已在开发中) - 维护 Project 级元数据。
2.  **Card Builder (卡片工坊)**: `cardv8.html` (现有) - 专注子项目的可视化呈现与微调。
3.  **Timetable (全景视图)**: `project_timeline.html` (现有) - 聚合所有 Project 及其 SubProjects 的进度。
4.  **Admin (后台配置)**: **(新规划)** - 维护人员名单、货架清单等基础数据。

---

## 2. 关键问题解决方案

### Q1: 负责人多选与维护
*   **方案**: 在 `projects.json` 中，`team` 字段由 `{ "sales": "Name" }` 升级为 `{ "sales": ["Name1", "Name2"] }`。
*   **实现**: 前端使用 `TagInput` 组件（输入回车生成标签），数据源读取 `users.json` (新文件) 或直接允许自由输入+历史记录补全。

### Q2: 货架清单管理
*   **方案**: 新增 `catalog.json` 存储标准清单。
*   **实现**:
    *   **后台**: 简单页面维护 `catalog.json`。
    *   **前台**: 项目详情页的“交付物”从文本框改为**下拉选择+自由输入**。自由输入的新条目可标记为“待入库”，后台审核后存入 `catalog.json`。

### Q3: 旧版数据迁移
*   **方案**: 编写一次性迁移脚本 `migrate_v1_to_v2.py`。
*   **逻辑**: 遍历 `project_cards.json`，根据 `1205-PROJ` 前缀自动创建对应的 Project 条目到 `projects.json`，并将卡片标记为该 Project 的子项。

### Q4: 新建卡片关联与保存问题
*   **方案**: 修复 `cardv8.html`。
    *   **入参**: 接受 `?parentId=...`。
    *   **保存**: 保存时强制检查 `parent_project_id`。如果缺失，弹出“选择所属项目”对话框。

### Q5: 预算聚合策略
*   **方案**: Project 增加 `budget_mode` 字段 (`manual` | `auto_sum`)。
    *   `manual`: 手动录入总数。
    *   `auto_sum`: 自动累加所有子卡片的预算。前端显示时根据此字段计算。

---

## 3. 开发实施计划 (Roadmap)

### Phase 1: 基础数据结构升级 (Current Turn)
1.  **Refactor**: 创建 `database/` 目录，初始化 `users.json`, `catalog.json`。
2.  **Backend**: 升级 `server.py`，支持对上述新文件的 CRUD 操作。
3.  **Migration**: 执行数据清洗，将现有分散的“负责人”和“交付物”提取到主数据文件中。

### Phase 2: 项目详情页增强 (Next Step)
1.  **UI**: 改造 `project_detail.html`。
    *   人员选择改为多选标签。
    *   交付物改为“选择/录入”双模式。
2.  **Logic**: 实现“子项目卡片”的**创建入口**，确保携带 `parentId` 跳转。

### Phase 3: 卡片编辑器适配
1.  **Fix**: 修复 `cardv8.html` 的保存逻辑，确保它能正确读取并回写关联关系。
2.  **UI**: 在卡片页增加“所属项目信息”只读面板（从 `projects.json` 读取）。

### Phase 4: 数据库化 (Future)
1.  引入 SQLite。
2.  将 JSON 读写层替换为 SQL 查询层。

---

## 4. 本次执行任务 (Action Items)

为了响应您的需求，我将在本次对话中执行以下操作：

1.  **架构文档化**: 将上述规划写入 `docs/02-系统架构设计.md`。
2.  **基础数据初始化**: 创建 `data/` 目录及 `catalog.json`, `users.json`。
3.  **后端升级**: 更新 `server.py` 以支持基础数据的读取。
4.  **修复关联流程**: 修改 `project_detail.html` -> `cardv8.html` 的跳转与保存逻辑，解决“无法保存”的 Bug。
5.  **数据迁移**: 尝试将现有的卡片归集到“1205客户数字健康项目”下。

请确认是否开始执行？