# 开发进度与过程日志

## 2025-12-26: 功能对齐与交互优化

### 🌟 今日里程碑
实现了 `projects.html` 与 `index.html` 的功能对齐，解决了多分辨率下的 UI 适配问题，并打通了项目详情页的跳转逻辑。

### 🚀 核心功能更新
1.  **project_detail.html 深度增强与批量操作**：
    *   **关联卡片批量管理**：
        *   **多选/全选功能**：在“关联项目卡片”区域增加了复选框，支持单选、多选及一键全选。
        *   **批量导入 (Markdown)**：支持将多个 Markdown 格式的卡片文件直接导入到当前项目下。
        *   **批量导出**：支持将选中的卡片一键导出为合并的 Markdown 文档。
        *   **预算统计弹窗**：新增“选中卡片预算统计”弹窗，可实时计算选中项的总金额（万）和总工时（人天），并展示详细清单。
        *   **Excel/CSV 导出**：支持将选中卡片的预算数据导出为带 BOM 的 CSV 文件（Excel 可直接打开），包含编号、名称、金额及工时。
    *   **视图切换**：实现了“网格视图”与“列表视图”的无缝切换，方便在大规模卡片场景下快速检索。
    *   **状态反馈**：增加了“已选择 X 项”的实时统计显示。
2.  **projects.html 功能完备化**：
    *   **导入导出 (Markdown)**：实现了从 Markdown 批量导入卡片的功能，并支持将项目及关联卡片导出为 Markdown 报告。
    *   **备份与迁移**：增加了 JSON 备份与导入功能，确保项目数据可持久化并支持跨环境迁移。
    *   **预算分析**：集成了预算统计功能，支持自动计算总金额和总工时，并提供详细的预算分析弹窗。
3.  **UI 响应式优化**：
    *   **过滤栏重构**：通过 `flex-wrap` 和 `min-width` 约束，确保搜索、状态过滤、视图切换及导入导出按钮在小屏幕下不被遮挡或折叠。
    *   **弹窗体验**：优化了预算分析弹窗的移动端显示，增加了自定义滚动条和响应式内边距。
4.  **数据解析增强**：
    *   **cardv8 解析修复**：修复了“预算投入”字段在特定换行情况下被归类到“所需支持”的问题，增强了正则匹配的鲁棒性。

### 🚨 待完成任务
1.  **自动化关联增强**：优化卡片与项目的自动关联算法，支持更灵活的编号匹配规则。
2.  **导出格式优化**：进一步美化导出到 Markdown 的排版样式。
3.  **批量删除**：在 project_detail 页面增加对选中卡片的批量移除/删除功能。

---

## 2025-12-25: 全面重构与功能完备（每日总结）

### 🌟 今日里程碑
本日完成了从“单页原型”到“生产级应用”的跨越。不仅解决了严重的交互稳定性问题（白屏、点击失效），还完善了数据流转逻辑，并提升了 UI 质感。

### 🚀 核心功能更新 (Late Night Updates)
1.  **数据逻辑修复 (Critical)**：
    *   **身份追踪 (`activeCardId`)**：修复了“修改项目编号/名称导致新建卡片”的逻辑漏洞。现在系统通过内部 ID 追踪卡片，支持随意重命名项目。
    *   **实时同步**：修改卡片名称后，左侧控制台下拉框会立即更新，无需刷新。
2.  **文件导入/导出**：
    *   **Markdown 批量导入**：新增 `.md` 文件解析器，支持自动识别“项目名称：”、“项目目标：”等键值对，批量生成卡片。
    *   **样式持久化**：卡片的个性化设置（字体大小、模块高度、主题色）现在会随卡片数据一起存入数据库。
3.  **时间表联动控制**：
    *   **启用/禁用机制**：在首页列表和卡片页增加了“启用/禁用”开关。禁用的卡片将自动从 Timeline 时间表中隐藏，方便管理废弃或暂缓的项目。
4.  **UI/UX 最终打磨**：
    *   **紧凑布局**：将模块间距从 `gap-8` 优化为 `gap-5`，提升屏幕利用率。
    *   **排版优化**：标题字号调至 18px，行间距优化至 1.35，预算模块底色定制为莫兰迪色 (#C5AA99)。

### 🚨 紧急修复 (Late Night 2) - "白屏终结者"
1.  **彻底移除 CDN 依赖**：
    *   **现象**：用户反馈多次出现白屏，经查是 `unpkg.com` 的 `lucide` 库版本不稳定（404 或 API 变更）导致。
    *   **措施**：已下载 `lucide.min.js` (v0.469.0) 到本地 `js/` 目录，并强制 `cardv8.html` 引用本地文件。
    *   **教训**：对于关键基础设施（如图标库），在生产环境中**绝对不要依赖公网 CDN**，必须本地化。
3.  **诊断模式植入 (Diagnostic Mode)**：
    *   **问题**：白屏难以排查，用户无法反馈具体错误。
    *   **措施**：在 `cardv8.html` 头部注入 `window.onerror` 全局错误捕获器。
    *   **效果**：一旦发生 JS 错误或依赖缺失，屏幕将直接显示红色的错误详情堆栈，不再只是“一片白”，极大降低排查难度。
4.  **内联关键依赖 (Inlining)**：
    *   **问题**：即使本地化了 JS 文件，仍可能因路径映射或缓存问题导致加载失败。
    *   **措施**：使用脚本将 `lucide.min.js` 的内容**直接注入**到 HTML 文件中。
    *   **结果**：彻底消除网络请求，只要 HTML 能打开，图标库就一定存在。
5.  **防御性编程增强**：
    *   引入 React `ErrorBoundary` 全局错误边界，即使组件崩溃也能显示友好的错误提示，而不是白屏。
    *   重写 `Icon` 组件，增加对 `window.lucide` 缺失的容错处理（显示占位符）。

---

### ⚠️ 遇到的重大问题与复盘 (早些时候)

#### 1. "所需支持" 复选框无法点选/文本无法选中
- **现象**：用户点击“所需支持”模块时，要么没反应，要么无法勾选复选框。
- **根本原因**：代码结构不一致。该模块被包裹在一个额外的 `div` 中，且该 `div` 绑定了与其子元素冲突的 `onClick` 事件。
- **解决方案**：**组件化重构**。废弃硬编码 HTML，创建统一的 `<CardSection />` 组件，标准化 9 个模块的渲染逻辑。

#### 2. 页面白屏 / "一跳就崩"
- **现象**：用户点击页面任意位置，或刷新页面后，页面直接变白。
- **根本原因**：`lucide-react` 图标库直接操作 DOM 导致 React 虚拟 DOM 树同步失败。
- **解决方案**：**防御性编程**。重写 `Icon` 组件，移除全局依赖，改为手动管理 SVG 字符串注入，并包裹 `try-catch`。

#### 3. Timetable 数据不同步
- **现象**：卡片修改时间后，时间表不更新。
- **解决方案**：**双向同步**。在卡片页增加“同步数据库”按钮，显式触发后端保存；时间表页支持手动覆盖时间。

### 📝 开发经验总结
- **组件化是王道**：当 UI 问题反复出现时，不要打 CSS 补丁，直接重构组件。
- **ID 优于 Name**：永远不要用用户可编辑的字段（如“项目编号”）作为数据主键。引入 `uuid` 或 `timestamp` 作为内部 ID。
- **防御性渲染**：第三方库（图标、编辑器）必须隔离，防止其崩溃拖垮整个页面。

## 2024-12-24: 列表视图与数据管理增强
(保留历史记录...)
