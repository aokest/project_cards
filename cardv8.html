<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®å¡ç‰‡ç”Ÿæˆå™¨ v9.2 (Final Ultimate)</title>
    <!-- ä½¿ç”¨ cdnjs æ›¿ä»£æœ¬åœ°æ–‡ä»¶ï¼Œæ›´ç¨³å®š -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨æœ¬åœ° Lucide åº“ï¼Œå½»åº•è§£å†³ CDN ä¸ç¨³å®šå¯¼è‡´çš„ç™½å±é—®é¢˜ -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    <script>
        // å…¨å±€é”™è¯¯æ•è· (Global Error Handler)
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global Error Caught:", message, error);
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="padding: 2rem; color: #7f1d1d; background: #fef2f2; height: 100vh; font-family: sans-serif;">
                        <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">ğŸš¨ é¡µé¢å‘ç”Ÿè‡´å‘½é”™è¯¯</h1>
                        <p style="margin-bottom: 0.5rem;"><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong> ${message}</p>
                        <p style="margin-bottom: 0.5rem;"><strong>ä½ç½®ï¼š</strong> ${source}:${lineno}:${colno}</p>
                        <pre style="background: rgba(0,0,0,0.05); padding: 1rem; border-radius: 0.5rem; overflow: auto;">${error && error.stack ? error.stack : 'No stack trace available'}</pre>
                        <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #dc2626; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">åˆ·æ–°é‡è¯•</button>
                    </div>
                `;
            }
        };

        // æ£€æŸ¥å…³é”®ä¾èµ– (Dependency Check)
        window.addEventListener('DOMContentLoaded', () => {
            const missing = [];
            if (!window.React) missing.push('React');
            if (!window.ReactDOM) missing.push('ReactDOM');
            if (!window.lucide) missing.push('Lucide Icons');
            
            if (missing.length > 0) {
                throw new Error(`å…³é”®ä¾èµ–åº“æœªåŠ è½½: ${missing.join(', ')}ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–æœ¬åœ° js ç›®å½•æ–‡ä»¶æ˜¯å¦å®Œæ•´ã€‚`);
            }
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; margin: 0; padding: 0; background-color: #f3f4f6; }
        
        /* äº¤äº’æ ¸å¿ƒæ ·å¼ */
        .section-hover-ring { transition: all 0.2s; border: 2px solid transparent; }
        .section-hover-ring:hover { border-color: rgba(59, 130, 246, 0.3); }
        .section-selected { border-color: #3b82f6 !important; background-color: rgba(59, 130, 246, 0.05); }
        
        /* å¤é€‰æ¡†äº¤äº’åŒºåŸŸ */
        .checkbox-area { cursor: pointer; user-select: none; }
        .text-content-area { cursor: text; user-select: text; }
        
        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">
    <div id="root" class="w-full h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 1. å¸¸é‡ä¸é…ç½® ---
        const STORAGE_KEY = 'project_cards_v9_final';
        const EMPTY_TEMPLATE = [
            'é¡¹ç›®ç¼–å·ï¼š',
            'é¡¹ç›®åç§°ï¼š',
            'é¡¹ç›®ç›®æ ‡ï¼š',
            'ç°çŠ¶åˆ†æï¼š',
            'é¡¹ç›®å‘¨æœŸï¼š',
            'é¢„ç®—æŠ•å…¥ï¼š',
            'æ‰€éœ€æ”¯æŒï¼š',
            'é¡¹ç›®å†…å®¹ï¼š',
            'å‚ä¸éƒ¨é—¨ï¼š',
            'ç›¸å…³äº§å“åŠè§£å†³æ–¹æ¡ˆï¼š',
            'è¾“å‡ºç‰©ï¼š'
        ].join('\n');

        // å­—æ®µæ˜ å°„é…ç½®
        const FIELD_CONFIG = {
            'é¡¹ç›®ç›®æ ‡': { icon: 'target', minHeight: 200 },
            'ç°çŠ¶åˆ†æ': { icon: 'bar-chart-3', minHeight: 200 },
            'é¡¹ç›®å†…å®¹': { icon: 'file-text', minHeight: 280 },
            'æ‰€éœ€æ”¯æŒ': { icon: 'life-buoy', minHeight: 200, isChecklist: true },
            'é¢„ç®—æŠ•å…¥': { icon: 'coins', minHeight: 200, isBudget: true },
            'é¡¹ç›®å‘¨æœŸ': { icon: 'clock', minHeight: 260 },
            'å‚ä¸éƒ¨é—¨': { icon: 'users', minHeight: 120 },
            'ç›¸å…³äº§å“åŠè§£å†³æ–¹æ¡ˆ': { icon: 'package', minHeight: 120 },
            'è¾“å‡ºç‰©': { icon: 'check-circle-2', minHeight: 180 }
        };

        const PALETTES = [
            { name: 'Slate Pro', themeColor: '#0f172a', accentColor: '#f1f5f9', textColor: '#334155', cardBg: '#FFFFFF', budgetColor: '#C5AA99' },
            { name: 'Deep Blue', themeColor: '#1e3a8a', accentColor: '#eef2ff', textColor: '#0f172a', cardBg: '#FFFFFF', budgetColor: '#0ea5e9' },
            { name: 'Forest', themeColor: '#166534', accentColor: '#dcfce7', textColor: '#052e1a', cardBg: '#FFFFFF', budgetColor: '#16a34a' },
            { name: 'Night', themeColor: '#111827', accentColor: '#1f2937', textColor: '#e5e7eb', cardBg: '#0b1220', budgetColor: '#f59e0b' },
            { name: 'Teal', themeColor: '#0f766e', accentColor: '#ccfbf1', textColor: '#083c3b', cardBg: '#FFFFFF', budgetColor: '#14b8a6' },
            { name: 'Ink', themeColor: '#1e293b', accentColor: '#e2e8f0', textColor: '#0f172a', cardBg: '#FFFFFF', budgetColor: '#475569' }
        ];

        // --- 2. åŸºç¡€ç»„ä»¶ ---
        // Helper for Lucide icon name conversion (kebab-case to PascalCase)
        const toPascalCase = (str) => {
            if (!str) return '';
            return str.replace(/(^\w|-\w)/g, (clear) => clear.replace('-', '').toUpperCase());
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const containerRef = useRef(null);
            
            useEffect(() => {
                if (!name || !window.lucide || !window.lucide.icons) return;
                
                try {
                    const iconName = toPascalCase(name);
                    const iconNode = window.lucide.icons[iconName];
                    
                    if (iconNode) {
                        const svg = iconNode.toSvg({
                            'class': className,
                            'width': size,
                            'height': size,
                            'stroke-width': 2
                        });
                        if (containerRef.current) {
                            containerRef.current.innerHTML = svg;
                        }
                    }
                } catch (e) {
                    console.warn('Icon render failed:', name);
                }
            }, [name, size, className]);

            return <span ref={containerRef} style={{ display: 'inline-flex', width: size, height: size }} />;
        };

        // --- 3. æ ¸å¿ƒä¸šåŠ¡ç»„ä»¶ï¼šCardSection (æ ‡å‡†åŒ–å¡ç‰‡æ¨¡å—) ---
        const CardSection = ({ 
            title, 
            content, 
            config, 
            globalStyles, 
            isSelected, 
            onSelect, 
            onResize, 
            onToggleCheck, 
            customClass = "" 
        }) => {
            const { icon, minHeight, isChecklist, isBudget } = FIELD_CONFIG[title] || { icon: 'circle', minHeight: 150 };
            const currentHeight = (config && config.minHeight) || minHeight;
            const fontPx = (config && config.fontPx) || 18;

            const handleSectionClick = (e) => {
                // å¦‚æœç‚¹å‡»çš„æ˜¯äº¤äº’åŒºåŸŸï¼ˆå¤é€‰æ¡†ï¼‰ï¼Œä¸è§¦å‘é€‰æ‹©
                if (e.target.closest('.interactive-area')) return;
                // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘çˆ¶çº§ç‚¹å‡»
                e.stopPropagation();
                e.preventDefault(); // Prevent potential link navigation
                onSelect(title);
            };

            const renderContent = () => {
                if (!content) return <span className="opacity-30 italic">æš‚æ— å†…å®¹</span>;

                if (isBudget) {
                    return (
                        <div className="flex flex-col items-center justify-center h-full text-center font-mono font-bold whitespace-pre-wrap">
                            {content}
                        </div>
                    );
                }

                const lines = content.split('\n').filter(l => l.trim());
                const isListFormat = isChecklist || lines.some(l => /^(-|\d+\.|\[)/.test(l));

                if (isListFormat) {
                    return (
                        <ul className="flex flex-col gap-2">
                            {lines.map((line, idx) => {
                                const checkMatch = line.match(/^- \[( |x)\]\s*(.*)/);
                                const isChecked = checkMatch && checkMatch[1] === 'x';
                                const cleanText = checkMatch ? checkMatch[2] : line.replace(/^(-|\d+\.)\s*/, '');
                                
                                return (
                                    <li key={idx} className="flex items-start gap-3 relative group">
                                        <div 
                                            className="interactive-area mt-1 shrink-0 cursor-pointer text-gray-400 hover:text-blue-500 transition-colors"
                                            onClick={(e) => { e.stopPropagation(); onToggleCheck(title, line); }}
                                        >
                                            {isChecklist || checkMatch ? (
                                                isChecked ? <Icon name="check-square" size={18} className="text-blue-600" /> : <Icon name="square" size={18} />
                                            ) : (
                                                <div className="w-1.5 h-1.5 rounded-full bg-current mt-2 opacity-50"></div>
                                            )}
                                        </div>
                                        <div 
                                            className={`text-content-area flex-1 ${isChecked ? 'line-through opacity-60' : ''}`}
                                            onClick={(e) => e.stopPropagation()} 
                                        >
                                            {cleanText}
                                        </div>
                                    </li>
                                );
                            })}
                        </ul>
                    );
                }
                return <div className="whitespace-pre-wrap text-content-area" onClick={e=>e.stopPropagation()}>{content}</div>;
            };

            return (
                <div 
                    className={`rounded-[1.5rem] p-5 border transition-all relative flex flex-col gap-3 overflow-hidden section-hover-ring backdrop-blur-xl ${customClass} ${isSelected ? 'section-selected shadow-lg ring-1 ring-blue-400' : 'border-gray-200/60 bg-white/60 shadow-sm'}`}
                    style={{ 
                        height: `${currentHeight}px`,
                        minHeight: `${currentHeight}px`,
                        borderColor: isSelected ? '#3b82f6' : `${globalStyles.themeColor}30`,
                        backgroundColor: isBudget ? globalStyles.budgetColor : (title === 'æ‰€éœ€æ”¯æŒ' ? `${globalStyles.accentColor}50` : undefined)
                    }}
                    onClick={handleSectionClick}
                >
                    <div className="flex items-center gap-2 font-bold opacity-80 select-none" style={{ color: isBudget ? 'white' : globalStyles.themeColor }}>
                        <Icon name={icon} size={22} className={isBudget ? 'text-white' : ''} />
                        <span className="uppercase tracking-wider text-lg">{title}</span>
                    </div>
                    <div 
                        className="flex-1 min-h-0 overflow-hidden" 
                        style={{ 
                            fontSize: `${fontPx}px`, 
                            color: isBudget ? 'white' : globalStyles.textColor,
                            lineHeight: 1.35
                        }}
                    >
                        {renderContent()}
                    </div>
                    {isSelected && (
                        <div 
                            className="interactive-area absolute bottom-0 left-0 right-0 h-4 cursor-ns-resize flex items-center justify-center hover:bg-blue-100/50 z-20"
                            onMouseDown={(e) => {
                                const startY = e.clientY;
                                const startH = currentHeight;
                                const onMove = (ev) => onResize(title, Math.max(150, startH + (ev.clientY - startY)));
                                const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
                                window.addEventListener('mousemove', onMove);
                                window.addEventListener('mouseup', onUp);
                                e.stopPropagation();
                            }}
                        >
                            <div className="w-10 h-1 rounded-full bg-blue-300"></div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 4. ä¸»å¸ƒå±€ç»„ä»¶ï¼šProjectCard (æ¢å¤å·¦å³ç»“æ„ + åº•éƒ¨åŒæ ) ---
    const ProjectCard = ({ data, styles, sectionConfigs, selectedSection, actions, parentProjectName }) => {
        return (
            <div 
                className="w-[1920px] h-[1080px] relative overflow-hidden flex flex-col p-8 box-border shadow-2xl transition-colors duration-500"
                style={{ 
                    backgroundColor: styles.cardBg,
                    backgroundImage: `linear-gradient(135deg, ${styles.cardBg} 0%, ${styles.accentColor}20 100%)`
                }}
                onClick={(e) => { e.stopPropagation(); actions.selectSection(null); }}
            >
                {/* Subtle Texture Overlay */}
                <div className="absolute inset-0 opacity-[0.4] pointer-events-none" style={{
                    backgroundImage: `url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`
                }}></div>

                <div className="absolute top-0 right-0 w-[800px] h-[800px] rounded-full opacity-[0.03] blur-3xl pointer-events-none" style={{ backgroundColor: styles.themeColor }}></div>
                <div className="absolute top-12 bottom-12 left-0 w-3 rounded-r-xl" style={{ backgroundColor: styles.themeColor }}></div>
                
                <header className="flex items-end gap-6 pb-6 border-b-2 mb-6 shrink-0" style={{ borderColor: `${styles.themeColor}20` }}>
                    <div className="flex-1 truncate flex flex-col">
                        <h1 className="text-5xl font-black tracking-tighter leading-none" style={{ color: styles.textColor }}>
                            {data['é¡¹ç›®åç§°'] || 'æœªå‘½åé¡¹ç›®'}
                        </h1>
                        {parentProjectName && (
                            <div className="text-sm font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded inline-flex items-center gap-1 mt-2 w-fit opacity-80" style={{ fontFamily: 'Noto Sans SC' }}>
                                <Icon name="corner-up-left" size={14} />
                                æ‰€å±é¡¹ç›®: {parentProjectName}
                            </div>
                        )}
                    </div>
                    <div className="text-2xl font-mono font-bold border-2 px-5 py-2 rounded-lg opacity-80" style={{ borderColor: styles.textColor, color: styles.textColor }}>
                        {data['é¡¹ç›®ç¼–å·'] || 'NO.0000'}
                    </div>
                </header>

                    {/* ä¸»å¸ƒå±€ï¼šGrid 12 åˆ— */}
                    <div className="flex-1 grid grid-cols-12 gap-5 min-h-0">
                        
                        {/* å·¦ä¾§ (7åˆ—)ï¼šç›®æ ‡ã€ç°çŠ¶ã€å†…å®¹ã€æ”¯æŒã€é¢„ç®— */}
                        <div className="col-span-7 flex flex-col gap-5 h-full min-h-0">
                            {/* Row 1: ç›®æ ‡ & ç°çŠ¶ */}
                            <div className="grid grid-cols-2 gap-5 shrink-0">
                                <CardSection title="é¡¹ç›®ç›®æ ‡" content={data['é¡¹ç›®ç›®æ ‡']} config={sectionConfigs['é¡¹ç›®ç›®æ ‡']} globalStyles={styles} isSelected={selectedSection==='é¡¹ç›®ç›®æ ‡'} onSelect={actions.selectSection} onResize={actions.resizeSection} onToggleCheck={actions.toggleCheck} />
                                <CardSection title="ç°çŠ¶åˆ†æ" content={data['ç°çŠ¶åˆ†æ']} config={sectionConfigs['ç°çŠ¶åˆ†æ']} globalStyles={styles} isSelected={selectedSection==='ç°çŠ¶åˆ†æ'} onSelect={actions.selectSection} onResize={actions.resizeSection} onToggleCheck={actions.toggleCheck} />
                            </div>
                            
                            {/* Row 2: å†…å®¹ (è‡ªé€‚åº”) */}
                            <div className="flex-1 min-h-0 flex flex-col">
                                <CardSection title="é¡¹ç›®å†…å®¹" content={data['é¡¹ç›®å†…å®¹']} config={sectionConfigs['é¡¹ç›®å†…å®¹']} globalStyles={styles} isSelected={selectedSection==='é¡¹ç›®å†…å®¹'} onSelect={actions.selectSection} onResize={actions.resizeSection} onToggleCheck={actions.toggleCheck} customClass="h-full" />
                            </div>

                            {/* Row 3: æ”¯æŒ & é¢„ç®— (æ¢å¤å¹¶æ’å¸ƒå±€) */}
                            <div className="grid grid-cols-2 gap-5 shrink-0">
                                <CardSection title="æ‰€éœ€æ”¯æŒ" content={data['æ‰€éœ€æ”¯æŒ']} config={sectionConfigs['æ‰€éœ€æ”¯æŒ']} globalStyles={styles} isSelected={selectedSection==='æ‰€éœ€æ”¯æŒ'} onSelect={actions.selectSection} onResize={actions.resizeSection} onToggleCheck={actions.toggleCheck} />
                                <CardSection title="é¢„ç®—æŠ•å…¥" content={data['é¢„ç®—æŠ•å…¥']} config={sectionConfigs['é¢„ç®—æŠ•å…¥']} globalStyles={styles} isSelected={selectedSection==='é¢„ç®—æŠ•å…¥'} onSelect={actions.selectSection} onResize={actions.resizeSection} onToggleCheck={actions.toggleCheck} />
                            </div>
                        </div>

                        {/* å³ä¾§ (5åˆ—)ï¼šå‘¨æœŸã€éƒ¨é—¨ã€äº§å“ã€è¾“å‡ºç‰© */}
                        <div className="col-span-5 flex flex-col gap-5 h-full min-h-0">
                            <CardSection title="é¡¹ç›®å‘¨æœŸ" content={data['é¡¹ç›®å‘¨æœŸ']} config={sectionConfigs['é¡¹ç›®å‘¨æœŸ']} globalStyles={styles} isSelected={selectedSection==='é¡¹ç›®å‘¨æœŸ'} onSelect={actions.selectSection} onResize={actions.resizeSection} onToggleCheck={actions.toggleCheck} />
                            
                            <div className="grid grid-cols-1 gap-5">
                                <CardSection title="å‚ä¸éƒ¨é—¨" content={data['å‚ä¸éƒ¨é—¨']} config={sectionConfigs['å‚ä¸éƒ¨é—¨']} globalStyles={styles} isSelected={selectedSection==='å‚ä¸éƒ¨é—¨'} onSelect={actions.selectSection} onResize={actions.resizeSection} onToggleCheck={actions.toggleCheck} />
                                <CardSection title="ç›¸å…³äº§å“åŠè§£å†³æ–¹æ¡ˆ" content={data['ç›¸å…³äº§å“åŠè§£å†³æ–¹æ¡ˆ']} config={sectionConfigs['ç›¸å…³äº§å“åŠè§£å†³æ–¹æ¡ˆ']} globalStyles={styles} isSelected={selectedSection==='ç›¸å…³äº§å“åŠè§£å†³æ–¹æ¡ˆ'} onSelect={actions.selectSection} onResize={actions.resizeSection} onToggleCheck={actions.toggleCheck} />
                            </div>

                            <div className="flex-1 min-h-0 flex flex-col">
                                <CardSection title="è¾“å‡ºç‰©" content={data['è¾“å‡ºç‰©']} config={sectionConfigs['è¾“å‡ºç‰©']} globalStyles={styles} isSelected={selectedSection==='è¾“å‡ºç‰©'} onSelect={actions.selectSection} onResize={actions.resizeSection} onToggleCheck={actions.toggleCheck} customClass="h-full" />
                            </div>
                            
                            <div className="mt-auto pt-4 flex justify-between items-end opacity-40 shrink-0">
                                <span className="text-sm font-bold tracking-[0.3em]">CONFIDENTIAL</span>
                                <div className="flex items-center gap-2 text-sm font-bold">
                                    <Icon name="activity" size={20} />
                                    PROJECT CARD
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 7. AI Compare Modal ---
        const AICompareModal = ({ isOpen, onClose, originalText, newText, onApply }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
                    <div className="bg-white rounded-xl shadow-2xl w-[900px] h-[600px] flex flex-col p-6 animate-fade-in">
                        <div className="flex justify-between items-center border-b pb-4 mb-4">
                            <h2 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="sparkles" size={24} className="text-purple-600" />
                                AI æ¶¦è‰²ç»“æœç¡®è®¤
                            </h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icon name="x" size={20} /></button>
                        </div>
                        
                        <div className="flex-1 flex gap-4 min-h-0">
                            <div className="flex-1 flex flex-col">
                                <span className="text-sm font-bold text-gray-500 mb-2">åŸå§‹æ–‡æœ¬</span>
                                <textarea 
                                    className="flex-1 w-full p-4 border rounded-lg bg-gray-50 text-sm font-mono leading-relaxed resize-none" 
                                    value={originalText} 
                                    readOnly 
                                ></textarea>
                            </div>
                            <div className="flex items-center justify-center text-gray-300">
                                <Icon name="arrow-right" size={24} />
                            </div>
                            <div className="flex-1 flex flex-col">
                                <span className="text-sm font-bold text-purple-600 mb-2">AI æ¶¦è‰²å</span>
                                <textarea 
                                    className="flex-1 w-full p-4 border-2 border-purple-100 rounded-lg bg-white text-sm font-mono leading-relaxed resize-none focus:border-purple-500 outline-none" 
                                    value={newText} 
                                    readOnly
                                ></textarea>
                            </div>
                        </div>

                        <div className="flex justify-end gap-3 pt-4 border-t mt-4">
                            <button className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors" onClick={onClose}>å–æ¶ˆ</button>
                            <button className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium shadow-lg shadow-purple-200 transition-all transform hover:scale-105" onClick={onApply}>åº”ç”¨æ›´æ”¹</button>
                        </div>
                    </div>
                </div>
            );
        };
        const AIConfigModal = ({ isOpen, onClose, config, onSave }) => {
            const [localConfig, setLocalConfig] = useState(config);
            useEffect(() => { setLocalConfig(config); }, [config]);
            
            const handleSave = () => {
                onSave(localConfig);
                // Also save to global config for index.html
                localStorage.setItem('project_cards_ai_config', JSON.stringify(localConfig));
                onClose();
            };

            const exportConfig = () => {
                const blob = new Blob([JSON.stringify(localConfig, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'ai_config.json'; a.click();
            };

            const importConfig = (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.baseUrl !== undefined || data.apiKey !== undefined) {
                            setLocalConfig(prev => ({ ...prev, ...data }));
                            alert('é…ç½®å·²åŠ è½½');
                        } else {
                            alert('æ— æ•ˆçš„é…ç½®æ–‡ä»¶æ ¼å¼');
                        }
                    } catch (err) {
                        alert('æ— æ³•è§£æé…ç½®æ–‡ä»¶');
                    }
                };
                reader.readAsText(file);
            };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
                    <div className="bg-white rounded-xl shadow-2xl w-[500px] p-6 flex flex-col gap-4 animate-fade-in">
                        <div className="flex justify-between items-center border-b pb-4">
                            <h2 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="bot" size={24} className="text-blue-600" />
                                AI æ¨¡å‹é…ç½®
                            </h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icon name="x" size={20} /></button>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">API URL</label>
                                <input className="w-full mt-1 p-2 border rounded bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition-colors" value={localConfig.baseUrl} onChange={e=>setLocalConfig({...localConfig, baseUrl: e.target.value})} placeholder="https://api.openai.com/v1" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">API Key</label>
                                <input className="w-full mt-1 p-2 border rounded bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition-colors" type="password" value={localConfig.apiKey} onChange={e=>setLocalConfig({...localConfig, apiKey: e.target.value})} placeholder="sk-..." />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">Model Name</label>
                                <input className="w-full mt-1 p-2 border rounded bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition-colors" value={localConfig.model} onChange={e=>setLocalConfig({...localConfig, model: e.target.value})} placeholder="gpt-3.5-turbo" />
                            </div>
                        </div>
                        <div className="flex justify-between pt-4 border-t mt-2">
                            <div className="flex gap-2">
                                <button className="px-3 py-2 border rounded text-gray-600 hover:bg-gray-50 text-xs flex items-center gap-1" onClick={exportConfig}>
                                    <Icon name="download" size={14} /> å¯¼å‡ºé…ç½®
                                </button>
                                <label className="px-3 py-2 border rounded text-gray-600 hover:bg-gray-50 text-xs flex items-center gap-1 cursor-pointer">
                                    <Icon name="upload" size={14} /> å¯¼å…¥é…ç½®
                                    <input type="file" className="hidden" accept=".json" onChange={(e)=>importConfig((e.target.files && e.target.files[0]))} />
                                </label>
                            </div>
                            <div className="flex gap-3">
                                <button className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors" onClick={onClose}>å–æ¶ˆ</button>
                                <button className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-lg shadow-blue-200 transition-all transform hover:scale-105" onClick={handleSave}>ä¿å­˜é…ç½®</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 6. æ ¹åº”ç”¨ App ---
        const App = () => {
            const [rawText, setRawText] = useState(EMPTY_TEMPLATE);
            const [parsedData, setParsedData] = useState({});
            const [selectedSection, setSelectedSection] = useState(null);
            const [inputCardId, setInputCardId] = useState('');
            
            const [styles, setStyles] = useState({
                themeColor: '#0f172a', accentColor: '#f1f5f9', textColor: '#334155', cardBg: '#ffffff', budgetColor: '#C5AA99'
            });
            const [sectionConfigs, setSectionConfigs] = useState({});
            
            const [isAIModalOpen, setIsAIModalOpen] = useState(false);
            const [isAICompareOpen, setIsAICompareOpen] = useState(false);
            const [aiResult, setAIResult] = useState('');
            const [history, setHistory] = useState([]); // For undo
            const [aiConfig, setAiConfig] = useState({ baseUrl: 'https://api.openai.com/v1', apiKey: '', model: 'gpt-3.5-turbo' });
            const [isAILoading, setIsAILoading] = useState(false);
            
            // New: Card List for Selection
            const [cardList, setCardList] = useState([]);
            // Track the original ID of the currently edited card to support renaming/overwriting
            const [activeCardId, setActiveCardId] = useState(null);
            
            // Parent Project Context
            const [parentProjectName, setParentProjectName] = useState(null);
            const [parentProjectId, setParentProjectId] = useState(null);

            useEffect(() => {
                if (!rawText) return;
                const lines = rawText.split('\n');
                const newData = {};
                let currentKey = null;
                const KEY_MAP = {
                    'é¡¹ç›®åç§°': 'é¡¹ç›®åç§°', 'é¡¹ç›®ç›®æ ‡': 'é¡¹ç›®ç›®æ ‡', 'ç°çŠ¶åˆ†æ': 'ç°çŠ¶åˆ†æ', 
                    'é¡¹ç›®å‘¨æœŸ': 'é¡¹ç›®å‘¨æœŸ', 'é¢„ç®—æŠ•å…¥': 'é¢„ç®—æŠ•å…¥', 'æ‰€éœ€æ”¯æŒ': 'æ‰€éœ€æ”¯æŒ',
                    'é¡¹ç›®å†…å®¹': 'é¡¹ç›®å†…å®¹', 'å‚ä¸éƒ¨é—¨': 'å‚ä¸éƒ¨é—¨', 'ç›¸å…³äº§å“åŠè§£å†³æ–¹æ¡ˆ': 'ç›¸å…³äº§å“åŠè§£å†³æ–¹æ¡ˆ',
                    'è¾“å‡ºç‰©': 'è¾“å‡ºç‰©', 'é¡¹ç›®ç¼–å·': 'é¡¹ç›®ç¼–å·'
                };
                lines.forEach(line => {
                    const match = line.match(/^([^\uff1a:]+)[\uff1a:](.*)/);
                    if (match && KEY_MAP[match[1].trim()]) {
                        currentKey = KEY_MAP[match[1].trim()];
                        newData[currentKey] = match[2].trim();
                    } else if (currentKey) {
                        newData[currentKey] = (newData[currentKey] ? newData[currentKey] + '\n' : '') + line.trim();
                    }
                });
                setParsedData(newData);
            }, [rawText]);

            // åŒæ­¥è¾“å…¥æ¡†çš„é¡¹ç›®ç¼–å·æ˜¾ç¤º
            useEffect(() => {
                const pn = parsedData['é¡¹ç›®ç¼–å·'] || '';
                setInputCardId(pn);
            }, [parsedData['é¡¹ç›®ç¼–å·']]);

            // å‡½æ•°ï¼šæ›´æ–°åŸå§‹æ–‡æœ¬ä¸­çš„â€œé¡¹ç›®ç¼–å·ï¼šâ€è¡Œ
            // è¯´æ˜ï¼šæ”¯æŒ 3-4 æ®µç¼–å·ç»“æ„ [å®¢æˆ·]-[é¡¹ç›®]-S[é˜¶æ®µ]-[S/P][åºå·]ï¼Œè¿å­—ç¬¦ä¸å¤§å°å†™è‡ªåŠ¨è§„èŒƒåŒ–
            function updateProjectNumber(newId) {
                const normalize = (s) => (s || '')
                    .trim()
                    .replace(/[â€”â€“ï¼]/g, '-')
                    .toUpperCase();
                const id = normalize(newId);
                // å…è®¸ï¼š3 æ®µï¼ˆå« Sé˜¶æ®µ ä¸ [SP]åºå·ï¼‰æˆ– 4 æ®µï¼ˆå«é¡¹ç›®æ®µï¼‰
                const segs = id.split('-').filter(Boolean);
                const hasStage = segs.some(x => /^S\d+$/i.test(x));
                const hasType = segs.some(x => /^[SP]\d+$/i.test(x));
                const validLen = (segs.length === 3 && hasStage) || (segs.length === 4 && hasStage);
                const lines = rawText.split('\n');
                let hasLine = false;
                const next = lines.map((l) => {
                    if (/^\s*é¡¹ç›®ç¼–å·[\uff1a:]/.test(l)) {
                        hasLine = true;
                        return 'é¡¹ç›®ç¼–å·ï¼š' + id;
                    }
                    return l;
                });
                if (!hasLine) {
                    next.unshift('é¡¹ç›®ç¼–å·ï¼š' + id);
                }
                setRawText(next.join('\n'));
                setInputCardId(id);
                return !!(validLen && hasStage && (hasType || segs.length === 3));
            }

            const actions = {
                selectSection: (key) => setSelectedSection(key),
                resizeSection: (key, height) => setSectionConfigs(prev => ({ ...prev, [key]: { ...(prev[key] || {}), minHeight: height } })),
                updateFont: (key, size) => setSectionConfigs(prev => ({ ...prev, [key]: { ...(prev[key] || {}), fontPx: size } })),
                toggleCheck: (key, lineContent) => {
                    setRawText(prev => {
                        const lines = prev.split('\n');
                        return lines.map(l => {
                            if (l.includes(lineContent.replace(/^- \[( |x)\]\s*/, ''))) {
                                if (l.includes('- [ ]')) return l.replace('- [ ]', '- [x]');
                                if (l.includes('- [x]')) return l.replace('- [x]', '- [ ]');
                                return `- [x] ${l.replace(/^- /, '')}`;
                            }
                            return l;
                        }).join('\n');
                    });
                },
                save: () => {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({ rawText, styles, sectionConfigs, aiConfig }));
                    alert('å·²ä¿å­˜é¡¹ç›®æ•°æ®');
                },
                exportJSON: () => {
                    const blob = new Blob([JSON.stringify({ rawText, styles, sectionConfigs }, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = 'project_card.json'; a.click();
                },
                applyPalette: (p) => setStyles({ themeColor: p.themeColor, accentColor: p.accentColor, textColor: p.textColor, cardBg: p.cardBg, budgetColor: p.budgetColor }),
                runAI: async () => {
                    if (!aiConfig.apiKey) { alert('è¯·å…ˆé…ç½® AI API Key'); setIsAIModalOpen(true); return; }
                    setIsAILoading(true);
                    try {
                        const response = await fetch(`${aiConfig.baseUrl}/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                            body: JSON.stringify({
                                model: aiConfig.model,
                                messages: [
                                    { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªèµ„æ·±é¡¹ç›®ç®¡ç†ä¸“å®¶ã€‚è¯·æ¶¦è‰²ä»¥ä¸‹é¡¹ç›®å¡ç‰‡å†…å®¹ï¼Œä½¿å…¶æ›´åŠ ä¸“ä¸šã€ç®€æ´ã€æœ‰æ¡ç†ã€‚è¯·ä¿ç•™åŸæœ‰çš„é”®åï¼ˆå¦‚"é¡¹ç›®ç›®æ ‡ï¼š"ã€"ç°çŠ¶åˆ†æï¼š"ç­‰ï¼‰ï¼Œåªä¿®æ”¹å†…å®¹ã€‚è¯·ç›´æ¥è¾“å‡ºæ¶¦è‰²åçš„æ–‡æœ¬ï¼Œä¸è¦åŒ…å«å…¶ä»–è§£é‡Šã€‚' },
                                    { role: 'user', content: rawText }
                                ]
                            })
                        });
                        const data = await response.json();
                        if (data.choices && data.choices[0]) {
                            setAIResult(data.choices[0].message.content);
                            setIsAICompareOpen(true);
                        } else {
                            throw new Error('API è¿”å›æ ¼å¼é”™è¯¯');
                        }
                    } catch (e) {
                        alert('AI è¯·æ±‚å¤±è´¥: ' + e.message);
                    } finally {
                        setIsAILoading(false);
                    }
                },
                applyAI: () => {
                    setHistory(prev => [...prev, rawText]);
                    setRawText(aiResult);
                    setIsAICompareOpen(false);
                },
                undo: () => {
                    if (history.length === 0) return;
                    const prev = history[history.length - 1];
                    setRawText(prev);
                    setHistory(prevHist => prevHist.slice(0, -1));
                },
                saveToDB: async () => {
                    try {
                        // 1. Get current list
                        let currentList = [];
                        try {
                            const res = await fetch('/api/cards');
                            if (res.ok) currentList = await res.json();
                        } catch(e) { console.warn('Fetch failed, using empty list'); }
                        
                        // 2. Determine target ID and Card Object
                        // Use activeCardId if available (editing existing), otherwise create new ID
                        let targetId = activeCardId;
                        const projectNum = parsedData['é¡¹ç›®ç¼–å·'] || inputCardId;
                        
                        // Fallback: if no activeCardId but projectNum exists in list, assume we are editing that one
                        if (!targetId && projectNum) {
                            const existing = currentList.find(c => c.cardId === projectNum);
                            if (existing) targetId = existing.id;
                        }

                        // If still no targetId, generate new unique ID
                        if (!targetId) {
                            targetId = 'CARD-' + Date.now();
                            setActiveCardId(targetId);
                        }

                        const cardObj = {
                            id: targetId,
                            cardId: projectNum || targetId, // Visual ID (Project Number)
                            title: parsedData['é¡¹ç›®åç§°'] || 'æœªå‘½åé¡¹ç›®',
                            rawText: rawText,
                            data: parsedData,
                            styles: styles, 
                            sectionConfigs: sectionConfigs, 
                            isVisible: true,
                            updatedAt: new Date().toISOString()
                        };

                        // 3. Update or Append
                        const idx = currentList.findIndex(c => c.id === targetId);
                        if (idx >= 0) {
                            // Preserve existing visibility
                            if (currentList[idx].isVisible !== undefined) {
                                cardObj.isVisible = currentList[idx].isVisible;
                            }
                            currentList[idx] = cardObj;
                        } else {
                            currentList.push(cardObj);
                        }

                        // 4. Save back
                        const saveRes = await fetch('/api/cards', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(currentList)
                        });

                        if (saveRes.ok) {
                            setCardList(currentList); // Update dropdown immediately
                            // Update URL to ensure refresh stays on this card
                            const newUrl = new URL(window.location);
                            newUrl.searchParams.set('id', cardObj.cardId || cardObj.id);
                            window.history.pushState({}, '', newUrl);
                            
                            alert('å·²åŒæ­¥è‡³æ•°æ®åº“/æ—¶é—´è¡¨ï¼');
                        } else {
                            throw new Error('Server returned ' + saveRes.status);
                        }
                    } catch(e) {
                        alert('åŒæ­¥å¤±è´¥: ' + e.message);
                    }
                }
            };

            // Init Load
            useEffect(() => {
                // 0. Check for projectPrefix param to auto-fill ID
                const urlParams = new URLSearchParams(window.location.search);
                const projectPrefix = urlParams.get('projectPrefix');
                const parentId = urlParams.get('parentId');

                if (projectPrefix) {
                    // Auto-fill ID suggestion: Prefix-S1-P01
                    const suggestion = `${projectPrefix}-S1-P01`;
                    // Only set if we are creating new (no ID param)
                    if (!urlParams.get('id')) {
                         setParsedData(prev => ({ ...prev, 'é¡¹ç›®ç¼–å·': suggestion }));
                         setRawText(prev => {
                            if (prev.includes('é¡¹ç›®ç¼–å·ï¼š')) return prev.replace(/é¡¹ç›®ç¼–å·ï¼š.*/, `é¡¹ç›®ç¼–å·ï¼š${suggestion}`);
                            return `é¡¹ç›®ç¼–å·ï¼š${suggestion}\n` + prev;
                         });
                    }
                }
                
                // Store parentId if provided
                if (parentId) {
                    console.log("Associated with Parent Project:", parentId);
                    setParentProjectId(parentId);
                    // Save to state to use in UI rendering, instead of DOM manipulation
                    // We need a state for parentProjectName
                    fetch('/api/projects').then(r=>r.json()).then(projs => {
                        const p = projs.find(x => x.id === parentId);
                        if(p) {
                           setParentProjectName(p.meta.name);
                        }
                    });
                }

                // 1. Load Local Config (Styles, AI)
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        // Do not overwrite rawText immediately, prefer DB if available
                        if(data.styles) setStyles(data.styles);
                        if(data.sectionConfigs) setSectionConfigs(data.sectionConfigs);
                        if(data.aiConfig) setAiConfig(data.aiConfig);
                    } catch(e) {}
                }

                // 1.5 Load Global AI Config (Sync from Index)
                const globalAI = localStorage.getItem('project_cards_ai_config');
                if (globalAI) {
                    try {
                        const gConfig = JSON.parse(globalAI);
                        // If local AI config is default/empty, use global
                        setAiConfig(prev => (!prev.apiKey ? { ...prev, ...gConfig } : prev));
                    } catch(e) {}
                }

                // 2. Load Data from DB
                const fetchCards = async () => {
                    try {
                        const res = await fetch('/api/cards');
                        if (res.ok) {
                            const list = await res.json();
                            setCardList(list);
                            if (list.length > 0) {
                                // Find latest or by ID
                                const urlParams = new URLSearchParams(window.location.search);
                                const id = urlParams.get('id');
                                const target = id ? list.find(c => c.cardId === id || c.id === id) : list[list.length - 1]; // Default to latest
                                
                                if (target) {
                                    setRawText(target.rawText || EMPTY_TEMPLATE);
                                    if (target.styles) setStyles(target.styles);
                                    if (target.sectionConfigs) setSectionConfigs(target.sectionConfigs);
                                    setActiveCardId(target.id);
                                    console.log("Loaded card:", target.cardId);
                                }
                            }
                        }
                    } catch(e) {
                        console.error("Failed to load from DB", e);
                        // Fallback to local storage text if DB fails
                        if (saved) {
                            try {
                                const data = JSON.parse(saved);
                                if(data.rawText) setRawText(data.rawText);
                            } catch(e){}
                        }
                    }
                };
                fetchCards();
            }, []);

            const handleCardChange = (e) => {
                const id = e.target.value;
                const target = cardList.find(c => c.id === id || c.cardId === id);
                if (target) {
                    setRawText(target.rawText || EMPTY_TEMPLATE);
                    if (target.styles) setStyles(target.styles);
                    if (target.sectionConfigs) setSectionConfigs(target.sectionConfigs);
                    setActiveCardId(target.id);
                    setInputCardId(target.cardId || '');
                    // Update URL without reload
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('id', target.cardId || target.id);
                    window.history.pushState({}, '', newUrl);
                }
            };

            return (
                <div className="flex h-full">
                    <div className="w-96 bg-white border-r border-gray-200 flex flex-col shrink-0 z-10 shadow-xl">
                        <div className="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                            <h2 className="font-bold text-lg flex items-center gap-2 text-gray-800">
                                <Icon name="settings-2" size={20} />
                                æ§åˆ¶å°
                            </h2>
                            <button onClick={()=>setIsAIModalOpen(true)} className="text-blue-600 text-sm hover:underline flex items-center gap-1">
                                <Icon name="bot" size={14} /> AI è®¾ç½®
                            </button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-6 custom-scroll">
                            <div className="flex flex-col gap-2">
                                <div className="flex justify-between items-center">
                                    <label className="block text-xs font-bold text-gray-500 uppercase">é€‰æ‹©å¡ç‰‡</label>
                                    <span className="text-xs text-gray-400">{cardList.length} ä¸ªé¡¹ç›®</span>
                                </div>
                                <select 
                                    className="w-full p-2 border rounded-lg text-sm bg-gray-50 focus:bg-white outline-none"
                                    onChange={handleCardChange}
                                    value={parsedData['é¡¹ç›®ç¼–å·'] || ''}
                                >
                                    <option value="" disabled>é€‰æ‹©å·²æœ‰é¡¹ç›®...</option>
                                    {cardList.map(c => (
                                        <option key={c.id || c.cardId} value={c.id || c.cardId}>
                                            {c.cardId} - {(c.data && c.data['é¡¹ç›®åç§°']) || 'æœªå‘½å'}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div className="flex flex-col gap-2">
                                <div className="flex justify-between items-center">
                                    <label className="block text-xs font-bold text-gray-500 uppercase">é¡¹ç›®ç¼–å·</label>
                                    <span className="text-xs text-gray-400">ç¤ºä¾‹ï¼š1205-S1-S03</span>
                                </div>
                                <input 
                                    className={`w-full p-2 border rounded-lg text-sm bg-gray-50 focus:bg-white outline-none ${(() => {
                                        const v = (inputCardId||'').trim().replace(/[â€”â€“ï¼]/g,'-').toUpperCase();
                                        const segs = v.split('-').filter(Boolean);
                                        const hasStage = segs.some(x => /^S\\d+$/i.test(x));
                                        const hasType = segs.some(x => /^[SP]\\d+$/i.test(x));
                                        const validLen = (segs.length===3 && hasStage) || (segs.length===4 && hasStage);
                                        return (validLen && hasStage && (hasType || segs.length===3)) ? 'border-gray-300 focus:border-blue-500' : 'border-red-300 focus:border-red-500';
                                    })()}`}
                                    value={(inputCardId || '')} 
                                    onChange={(e)=> updateProjectNumber(e.target.value)}
                                    placeholder="1205-S1-S03"
                                />
                                {(() => {
                                    const v = (inputCardId||'').trim().replace(/[â€”â€“ï¼]/g,'-').toUpperCase();
                                    const segs = v.split('-').filter(Boolean);
                                    const hasStage = segs.some(x => /^S\\d+$/i.test(x));
                                    const hasType = segs.some(x => /^[SP]\\d+$/i.test(x));
                                    const validLen = (segs.length===3 && hasStage) || (segs.length===4 && hasStage);
                                    return !(validLen && hasStage && (hasType || segs.length===3));
                                })() && (
                                    <div className="text-xs text-red-500">ç¼–å·éœ€ 3-4 æ®µï¼ŒåŒ…å«é˜¶æ®µï¼ˆS1/S2â€¦ï¼‰ï¼Œå¯é€‰äº§å“/æœåŠ¡ï¼ˆP01/S01ï¼‰ã€‚ç¤ºä¾‹ï¼šACME-PJT-S1-P01 æˆ– 1205-S2-S01</div>
                                )}
                            </div>

                            <div className="flex flex-col gap-2">
                                <div className="flex justify-between items-center">
                                    <label className="block text-xs font-bold text-gray-500 uppercase">å†…å®¹ç¼–è¾‘</label>
                                    <button 
                                        onClick={actions.runAI} 
                                        disabled={isAILoading}
                                        className={`text-xs px-2 py-1 rounded flex items-center gap-1 transition-colors ${isAILoading ? 'bg-gray-200 text-gray-500' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}`}
                                    >
                                        <Icon name={isAILoading ? "loader-2" : "sparkles"} size={12} className={isAILoading ? "animate-spin" : ""} />
                                        {isAILoading ? 'AI æ€è€ƒä¸­...' : 'AI ä¸€é”®æ¶¦è‰²'}
                                    </button>
                                </div>
                                <textarea 
                                    className="w-full h-96 p-3 border rounded-lg text-sm font-mono leading-relaxed outline-none resize-none bg-gray-50 focus:bg-white focus:ring-2 ring-blue-100 transition-all" 
                                    value={rawText} 
                                    onChange={e => setRawText(e.target.value)}
                                ></textarea>
                                {history.length > 0 && (
                                    <div className="flex justify-end">
                                        <button onClick={actions.undo} className="text-xs text-gray-500 hover:text-gray-700 flex items-center gap-1">
                                            <Icon name="undo-2" size={12} /> æ’¤é”€æ›´æ”¹
                                        </button>
                                    </div>
                                )}
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-2 uppercase">é…è‰²é¢„è®¾</label>
                                <div className="grid grid-cols-3 gap-2">
                                    {PALETTES.map(p => (
                                        <button key={p.name} className="flex items-center gap-1 px-2 py-1.5 border rounded text-xs hover:bg-gray-50 transition-colors" onClick={()=>actions.applyPalette(p)}>
                                            <div className="w-3 h-3 rounded-full shadow-sm" style={{backgroundColor: p.themeColor}}></div>
                                            {p.name}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {selectedSection ? (
                                <div className="p-4 bg-blue-50 rounded-xl border border-blue-100 animate-fade-in">
                                    <div className="flex justify-between items-center mb-4">
                                        <span className="font-bold text-blue-900 flex items-center gap-2">
                                            <Icon name="sliders" size={16} />
                                            {selectedSection}
                                        </span>
                                        <button onClick={()=>setSelectedSection(null)} className="text-xs text-blue-500 hover:underline">å®Œæˆ</button>
                                    </div>
                                    <div className="space-y-4">
                                        <div>
                                            <div className="flex justify-between text-xs text-blue-800 mb-1 font-medium">
                                                <span>å­—ä½“å¤§å°</span>
                                                <span>{(sectionConfigs[selectedSection] && sectionConfigs[selectedSection].fontPx) || 16}px</span>
                                            </div>
                                            <input 
                                                type="range" 
                                                min="12" 
                                                max="48" 
                                                value={(sectionConfigs[selectedSection] && sectionConfigs[selectedSection].fontPx) || 16} 
                                                onChange={e => actions.updateFont(selectedSection, parseInt(e.target.value))} 
                                                className="w-full accent-blue-600 h-1 bg-blue-200 rounded-lg appearance-none cursor-pointer" 
                                            />
                                        </div>
                                        <div>
                                            <div className="flex justify-between text-xs text-blue-800 mb-1 font-medium">
                                                <span>æ¨¡å—é«˜åº¦</span>
                                                <span>{(sectionConfigs[selectedSection] && sectionConfigs[selectedSection].minHeight) || 'Auto'}</span>
                                            </div>
                                            <input 
                                                type="range" 
                                                min="100" 
                                                max="800" 
                                                value={(sectionConfigs[selectedSection] && sectionConfigs[selectedSection].minHeight) || 200} 
                                                onChange={e => actions.resizeSection(selectedSection, parseInt(e.target.value))} 
                                                className="w-full accent-blue-600 h-1 bg-blue-200 rounded-lg appearance-none cursor-pointer" 
                                            />
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="p-6 bg-gray-50 rounded-xl border border-dashed border-gray-300 text-center text-xs text-gray-400 flex flex-col items-center gap-2">
                                    <Icon name="mouse-pointer-2" size={24} className="opacity-50" />
                                    ç‚¹å‡»å³ä¾§å¡ç‰‡æ¨¡å—<br/>è°ƒæ•´å­—ä½“ä¸é«˜åº¦
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-3 pt-4 border-t">
                                <button onClick={actions.save} className="bg-gray-900 text-white py-2.5 rounded-lg hover:bg-black font-medium transition-all shadow-lg shadow-gray-200 flex items-center justify-center gap-2">
                                    <Icon name="save" size={16} /> ä¿å­˜
                                </button>
                                <button onClick={actions.saveToDB} className="bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700 font-medium transition-all shadow-lg shadow-blue-200 flex items-center justify-center gap-2">
                                    <Icon name="database" size={16} /> åŒæ­¥æ•°æ®åº“
                                </button>
                                <button onClick={actions.exportJSON} className="border border-gray-300 text-gray-700 py-2.5 rounded-lg hover:bg-gray-50 font-medium transition-colors flex items-center justify-center gap-2">
                                    <Icon name="download" size={16} /> å¯¼å‡º
                                </button>
                                <button onClick={() => {
                                    if (parentProjectId) {
                                        window.location.href = `project_detail.html?id=${parentProjectId}`;
                                    } else {
                                        window.location.href = 'index.html';
                                    }
                                }} className="border border-gray-300 text-gray-700 py-2.5 rounded-lg hover:bg-gray-50 font-medium transition-colors flex items-center justify-center gap-2">
                                    <Icon name={parentProjectId ? "corner-up-left" : "home"} size={16} /> 
                                    {parentProjectId ? "è¿”å›é¡¹ç›®" : "è¿”å›é¦–é¡µ"}
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 bg-gray-200 overflow-hidden flex items-center justify-center relative bg-grid-pattern">
                        <div className="absolute inset-0 opacity-[0.03]" style={{backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                        <div className="absolute inset-0 opacity-[0.02]" style={{
                            backgroundImage: `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E")`
                        }}></div>
                        <div style={{ transform: 'scale(0.65)', transformOrigin: 'center', boxShadow: '0 50px 100px -20px rgba(0, 0, 0, 0.25)' }}>
                            <ProjectCard data={parsedData} styles={styles} sectionConfigs={sectionConfigs} selectedSection={selectedSection} actions={actions} parentProjectName={parentProjectName} />
                        </div>
                    </div>

                    <AIConfigModal isOpen={isAIModalOpen} onClose={()=>setIsAIModalOpen(false)} config={aiConfig} onSave={setAiConfig} />
                    <AICompareModal 
                        isOpen={isAICompareOpen} 
                        onClose={()=>setIsAICompareOpen(false)} 
                        originalText={rawText} 
                        newText={aiResult} 
                        onApply={actions.applyAI} 
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
