<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é¡¹ç›®å¡ç‰‡ç®¡ç†ç³»ç»Ÿ</title>
  <!-- ä½¿ç”¨ cdnjs æ›¿ä»£æœ¬åœ°æ–‡ä»¶ï¼Œæ›´ç¨³å®š -->
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
        // å…¨å±€é”™è¯¯æ•è· (Global Error Handler)
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global Error Caught:", message, error);
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="padding: 2rem; color: #7f1d1d; background: #fef2f2; height: 100vh; font-family: sans-serif;">
                        <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">ğŸš¨ é¦–é¡µå‘ç”Ÿè‡´å‘½é”™è¯¯</h1>
                        <p style="margin-bottom: 0.5rem;"><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong> ${message}</p>
                        <p style="margin-bottom: 0.5rem;"><strong>ä½ç½®ï¼š</strong> ${source}:${lineno}:${colno}</p>
                        <pre style="background: rgba(0,0,0,0.05); padding: 1rem; border-radius: 0.5rem; overflow: auto;">${error && error.stack ? error.stack : 'No stack trace available'}</pre>
                        <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #dc2626; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">åˆ·æ–°é‡è¯•</button>
                    </div>
                `;
            }
        };

        // æ£€æŸ¥å…³é”®ä¾èµ– (Dependency Check)
        window.addEventListener('DOMContentLoaded', () => {
            const missing = [];
            if (!window.React) missing.push('React');
            if (!window.ReactDOM) missing.push('ReactDOM');
            // index.html ä¸ä¾èµ– Lucide å…¨å±€å¯¹è±¡ï¼Œæ‰€ä»¥ä¸æ£€æŸ¥ Lucide
            
            if (missing.length > 0) {
                throw new Error(`å…³é”®ä¾èµ–åº“æœªåŠ è½½: ${missing.join(', ')}ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–æœ¬åœ° js ç›®å½•æ–‡ä»¶æ˜¯å¦å®Œæ•´ã€‚`);
            }
        });
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap');
    body { font-family: 'Noto Sans SC', sans-serif; }
  </style>
</head>
<body class="bg-gray-100 text-slate-800">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const STORAGE_KEY = 'project_cards_v8';
    const api = {
        async load() {
            let serverData = [];
            try {
                const res = await fetch('/api/cards');
                if (res.ok) serverData = await res.json();
            } catch (e) { console.error("API Load Error", e); }
            
            let localData = [];
            try { const raw = localStorage.getItem(STORAGE_KEY); localData = raw ? JSON.parse(raw) : []; } catch {}

            // Migration Strategy (Smart Merge):
            if (localData.length > serverData.length) {
                console.log("Local data has more records. Preferring Local.");
                return { source: 'local', data: localData };
            }
            
            if (Array.isArray(serverData) && serverData.length > 0) {
                return { source: 'server', data: serverData };
            } 
            
            if (Array.isArray(localData) && localData.length > 0) {
                return { source: 'local', data: localData };
            }
            return { source: 'none', data: [] };
        },
        async save(cards) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
            const statusEl = document.getElementById('sync-status');
            if(statusEl) { statusEl.innerText = 'â˜ï¸ æ­£åœ¨ä¿å­˜åˆ°æ•°æ®åº“...'; statusEl.className = 'text-blue-600 font-bold'; }
            try {
                const res = await fetch('/api/cards', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(cards)
                });
                if(res.ok) {
                    if(statusEl) { 
                        statusEl.innerText = 'âœ… å·²ä¿å­˜åˆ°æœåŠ¡å™¨æ•°æ®åº“'; 
                        statusEl.className = 'text-green-600 font-bold';
                        setTimeout(()=> { if(statusEl.innerText.includes('å·²ä¿å­˜')) statusEl.innerText = ''; }, 3000); 
                    }
                } else {
                    throw new Error('Server returned ' + res.status);
                }
            } catch (e) { 
                console.error("API Save Error", e); 
                if(statusEl) { statusEl.innerText = 'âš ï¸ ä¿å­˜å¤±è´¥ (ä»…æœ¬åœ°ç¼“å­˜)'; statusEl.className = 'text-red-600 font-bold'; }
            }
        }
    };

    const readCards = () => { try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; } catch { return []; } };
    const writeCards = (cards) => { api.save(cards); }; // Wrapper to use new save logic

    // --- AI CONFIG MODAL (Copied & adapted from cardv8.html) ---
    const AIConfigModal = ({ isOpen, onClose }) => {
        const [config, setConfig] = useState({ enabled: false, apiKey: '', baseUrl: '', model: '' });
        const [testStatus, setTestStatus] = useState(null);
        const [testMessage, setTestMessage] = useState('');

        useEffect(() => {
            const saved = localStorage.getItem('project_cards_ai_config');
            if (saved) try { setConfig(JSON.parse(saved)); } catch {}
        }, [isOpen]);

        const saveConfig = (newConfig) => {
            setConfig(newConfig);
            localStorage.setItem('project_cards_ai_config', JSON.stringify(newConfig));
            onClose();
        };

        const PRESETS = [
            { name: 'OpenAI', baseUrl: 'https://api.openai.com/v1', model: 'gpt-4o-mini' },
            { name: 'DeepSeek', baseUrl: 'https://api.deepseek.com', model: 'deepseek-chat' },
            { name: 'Moonshot', baseUrl: 'https://api.moonshot.cn/v1', model: 'moonshot-v1-8k' },
            { name: 'Aliyun', baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1', model: 'qwen-plus' },
            { name: 'Zhipu', baseUrl: 'https://open.bigmodel.cn/api/paas/v4', model: 'glm-4' }
        ];

        const testConnection = async () => {
            setTestStatus('testing'); setTestMessage('Testing...');
            try {
                const baseUrl = config.baseUrl.replace(/\/$/, '');
                const res = await fetch(`${baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
                    body: JSON.stringify({ model: config.model, messages: [{ role: 'user', content: 'Hi' }], max_tokens: 5 })
                });
                if (!res.ok) throw new Error(await res.text());
                setTestStatus('success'); setTestMessage('OK!');
            } catch (e) { setTestStatus('error'); setTestMessage(e.message); }
        };

        if (!isOpen) return null;

        return (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
                <div className="bg-white rounded-xl shadow-xl w-[500px] p-6">
                    <h2 className="text-xl font-bold mb-4">å…¨å±€ AI é…ç½®</h2>
                    <div className="space-y-3">
                        <div className="flex gap-2">
                            {PRESETS.map(p => (
                                <button key={p.name} className="px-2 py-1 border rounded text-xs hover:bg-gray-50"
                                    onClick={() => setConfig(prev => ({ ...prev, baseUrl: p.baseUrl, model: p.model }))}>{p.name}</button>
                            ))}
                        </div>
                        <input className="w-full p-2 border rounded" placeholder="Base URL" value={config.baseUrl} onChange={e => setConfig({ ...config, baseUrl: e.target.value })} />
                        <input className="w-full p-2 border rounded" placeholder="API Key" type="password" value={config.apiKey} onChange={e => setConfig({ ...config, apiKey: e.target.value })} />
                        <input className="w-full p-2 border rounded" placeholder="Model" value={config.model} onChange={e => setConfig({ ...config, model: e.target.value })} />
                        <div className="flex items-center gap-2">
                            <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={config.enabled} onChange={e => setConfig({ ...config, enabled: e.target.checked })} /> å¯ç”¨</label>
                            <button className="px-2 py-1 text-xs border rounded" onClick={testConnection}>æµ‹è¯•è¿æ¥</button>
                            <span className="text-xs text-gray-500">{testMessage}</span>
                        </div>
                        <div className="flex justify-end gap-2 mt-4">
                            <button className="px-4 py-2 border rounded" onClick={onClose}>å–æ¶ˆ</button>
                            <button className="px-4 py-2 bg-blue-600 text-white rounded" onClick={() => saveConfig(config)}>ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const App = () => {
      const [cards, setCards] = useState([]);
      const [projects, setProjects] = useState([]);
      const [q, setQ] = useState('');
      const [showAIConfig, setShowAIConfig] = useState(false);
      const [selectedIds, setSelectedIds] = useState(new Set());
      const [showBudgetModal, setShowBudgetModal] = useState(false);
      const [viewMode, setViewMode] = useState('grid'); // 'grid' | 'list'
      const [dataSource, setDataSource] = useState('loading'); // 'server' | 'local'

      useEffect(() => { 
        const init = async () => {
            console.log("ğŸš€ Initializing application...");
            const { source, data } = await api.load();
            console.log(`ğŸ“Š Data loaded from: ${source}, count: ${data?.length || 0}`);
            setDataSource(source);
            
            if (data && data.length > 0) {
                setCards(data);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }

            // åŠ è½½é¡¹ç›®åˆ—è¡¨ç”¨äºå…³è”
            try {
                const pRes = await fetch('/api/projects');
                if (pRes.ok) {
                    const pData = await pRes.json();
                    console.log(`ğŸ“ Projects metadata loaded, count: ${pData?.length || 0}`);
                    setProjects(pData);
                } else {
                    console.warn(`âš ï¸ Failed to load projects: ${pRes.status}`);
                }
            } catch (e) { console.error("âŒ Projects Load Error", e); }
        };
        init();
      }, []);

      const forceReload = async () => {
          if(!confirm('ç¡®å®šè¦å¼ºåˆ¶ä»æœåŠ¡å™¨é‡æ–°åŠ è½½æ•°æ®å—ï¼Ÿæœ¬åœ°æœªä¿å­˜çš„ä¿®æ”¹å¯èƒ½ä¼šä¸¢å¤±ã€‚')) return;
          try {
              const res = await fetch('/api/cards?t='+Date.now());
              if (res.ok) {
                  const data = await res.json();
                  setCards(data);
                  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                  setDataSource('server');
                  alert(`å·²ä»æœåŠ¡å™¨åŠ è½½ ${data.length} æ¡æ•°æ®`);
              }
          } catch(e) { alert('åŠ è½½å¤±è´¥: ' + e.message); }
      };

      const filtered = useMemo(() => {
        const k = q.trim();
        if (!k) return cards;
        return cards.filter(c => (c.cardId || '').includes(k) || (c.title || '').includes(k));
      }, [cards, q]);

      const toggleSelect = (id) => {
        const next = new Set(selectedIds);
        if (next.has(id)) next.delete(id);
        else next.add(id);
        setSelectedIds(next);
      };

      const toggleSelectAll = () => {
          if (selectedIds.size === filtered.length) {
              setSelectedIds(new Set());
          } else {
              setSelectedIds(new Set(filtered.map(c => c.id)));
          }
      };

      const getSelectedCards = () => {
          return cards.filter(c => selectedIds.has(c.id));
      };

      const exportJSON = () => {
        const blob = new Blob([JSON.stringify(cards, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'project_cards.json'; a.click(); URL.revokeObjectURL(url);
      };

      const exportMarkdown = () => {
          const targetCards = selectedIds.size > 0 ? getSelectedCards() : cards;
          let md = `# é¡¹ç›®å¡ç‰‡å¯¼å‡º (${targetCards.length}ä¸ª)\n\n`;
          
          targetCards.forEach(c => {
              md += `## ${c.title || 'æœªå‘½åé¡¹ç›®'}\n\n`;
              md += `**ç¼–å·**: ${c.cardId || '-'}\n`;
              md += `**æ›´æ–°æ—¶é—´**: ${new Date(c.updatedAt || Date.now()).toLocaleString()}\n\n`;
              // Use rawText if available as it preserves the structure best
              if (c.rawText) {
                  md += c.rawText + '\n';
              } else {
                  // Fallback to constructing from fields
                  md += `**é¡¹ç›®ç›®æ ‡**: ${c.data?.['é¡¹ç›®ç›®æ ‡'] || ''}\n\n`;
                  md += `**é¢„ç®—æŠ•å…¥**: ${c.data?.['é¢„ç®—æŠ•å…¥'] || ''}\n\n`;
                  // ... add other fields if needed
              }
              md += `\n---\n\n`;
          });

          const blob = new Blob([md], { type: 'text/markdown' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'project_cards_export.md'; a.click(); URL.revokeObjectURL(url);
      };

      const calculateBudget = () => {
          setShowBudgetModal(true);
      };

      const BudgetModal = () => {
          if (!showBudgetModal) return null;
          
          const targetCards = selectedIds.size > 0 ? getSelectedCards() : cards;
          
          let totalMoney = 0;
          let totalManDays = 0;

          const list = targetCards.map(c => {
              const budgetText = (c.data?.['é¢„ç®—æŠ•å…¥'] || c.rawText?.match(/é¢„ç®—æŠ•å…¥[:ï¼š]([\s\S]*?)(?=\n[^\n]+[:ï¼š]|$)/)?.[1] || '').trim();
              
              // Money (ä¸‡)
              let money = 0;
              const moneyMatches = budgetText.match(/(\d+(\.\d+)?)\s*ä¸‡/g);
              if (moneyMatches) {
                  moneyMatches.forEach(m => money += parseFloat(m));
              }
              totalMoney += money;

              // Man-days (äººå¤©)
              let manDays = 0;
              const mdMatches = budgetText.match(/(\d+(\.\d+)?)\s*äººå¤©/g);
              if (mdMatches) {
                  mdMatches.forEach(m => manDays += parseFloat(m));
              }
              totalManDays += manDays;

              return {
                  id: c.id,
                  title: c.title,
                  text: budgetText,
                  money,
                  manDays
              };
          });

          const exportExcel = () => {
              // CSV with BOM for Excel support
              let csvContent = "\uFEFF"; 
              csvContent += "é¡¹ç›®åç§°,é¢„ç®—æè¿°,ä¼°ç®—é‡‘é¢(ä¸‡),ä¼°ç®—å·¥æ—¶(äººå¤©)\n";
              list.forEach(item => {
                  // Escape quotes and remove newlines for CSV safety
                  const safeText = (item.text || '').replace(/"/g, '""').replace(/\n/g, ' ');
                  csvContent += `"${item.title}","${safeText}",${item.money},${item.manDays}\n`;
              });
              csvContent += `æ€»è®¡,-,${totalMoney.toFixed(2)},${totalManDays}\n`;
              
              const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a'); a.href = url; a.download = 'é¢„ç®—ç»Ÿè®¡.csv'; a.click(); URL.revokeObjectURL(url);
          };

          return (
              <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
                  <div className="bg-white rounded-xl shadow-xl w-[900px] max-h-[80vh] flex flex-col p-6">
                      <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                         ğŸ’° é¢„ç®—ç»Ÿè®¡ ({targetCards.length}ä¸ªé¡¹ç›®)
                      </h2>
                      <div className="flex-1 overflow-auto border rounded">
                          <table className="w-full text-sm text-left">
                              <thead className="bg-gray-50 text-gray-600 sticky top-0">
                                  <tr>
                                      <th className="p-3">é¡¹ç›®åç§°</th>
                                      <th className="p-3">é¢„ç®—æè¿°</th>
                                      <th className="p-3 w-24 text-right">é‡‘é¢(ä¸‡)</th>
                                      <th className="p-3 w-24 text-right">å·¥æ—¶(äººå¤©)</th>
                                  </tr>
                              </thead>
                              <tbody className="divide-y">
                                  {list.map(item => (
                                      <tr key={item.id}>
                                          <td className="p-3 font-medium">{item.title}</td>
                                          <td className="p-3 text-xs text-gray-500 whitespace-pre-wrap">{item.text || '-'}</td>
                                          <td className="p-3 text-right font-mono text-blue-600">{item.money > 0 ? item.money : '-'}</td>
                                          <td className="p-3 text-right font-mono text-green-600">{item.manDays > 0 ? item.manDays : '-'}</td>
                                      </tr>
                                  ))}
                              </tbody>
                          </table>
                      </div>
                      <div className="mt-4 pt-4 border-t flex justify-between items-center bg-gray-50 p-4 rounded">
                          <div className="text-xs text-gray-500">
                              * ä»…ç»Ÿè®¡æ˜¾å¼åŒ…å«â€œxxä¸‡â€æˆ–â€œxxäººå¤©â€çš„æ•°å€¼ã€‚è¯·äººå·¥æ ¸å¯¹ã€‚
                          </div>
                          <div className="flex gap-4 text-lg font-bold">
                              <div>æ€»é‡‘é¢: <span className="text-blue-600">{totalMoney.toFixed(2)}</span> ä¸‡</div>
                              <div>æ€»å·¥æ—¶: <span className="text-green-600">{totalManDays}</span> äººå¤©</div>
                          </div>
                      </div>
                      <div className="mt-4 flex justify-end gap-2">
                          <button className="px-4 py-2 border rounded hover:bg-gray-50 flex items-center gap-1" onClick={exportExcel}>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                              å¯¼å‡º Excel
                          </button>
                          <button className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300" onClick={() => setShowBudgetModal(false)}>å…³é—­</button>
                      </div>
                  </div>
              </div>
          );
      };

      const importJSON = (file) => {
        if (!file) return;
        file.text().then(t => { try { const arr = JSON.parse(t); if (Array.isArray(arr)) { writeCards(arr); setCards(arr); } } catch {} });
      };

      const importMarkdown = async (files) => {
        if (!files || files.length === 0) return;
        
        const KEY_MAP = {
            'é¡¹ç›®åç§°': 'é¡¹ç›®åç§°', 'é¡¹ç›®ç›®æ ‡': 'é¡¹ç›®ç›®æ ‡', 'ç°çŠ¶åˆ†æ': 'ç°çŠ¶åˆ†æ', 
            'é¡¹ç›®å‘¨æœŸ': 'é¡¹ç›®å‘¨æœŸ', 'é¢„ç®—æŠ•å…¥': 'é¢„ç®—æŠ•å…¥', 'æ‰€éœ€æ”¯æŒ': 'æ‰€éœ€æ”¯æŒ',
            'é¡¹ç›®å†…å®¹': 'é¡¹ç›®å†…å®¹', 'å‚ä¸éƒ¨é—¨': 'å‚ä¸éƒ¨é—¨', 'ç›¸å…³äº§å“åŠè§£å†³æ–¹æ¡ˆ': 'ç›¸å…³äº§å“åŠè§£å†³æ–¹æ¡ˆ',
            'è¾“å‡ºç‰©': 'è¾“å‡ºç‰©', 'é¡¹ç›®ç¼–å·': 'é¡¹ç›®ç¼–å·'
        };

        let newCards = [];
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const text = await file.text();
            
            // Parse logic
            const lines = text.split('\n');
            const data = {};
            let currentKey = null;
            
            lines.forEach(line => {
                const match = line.match(/^([^\uff1a:]+)[\uff1a:](.*)/);
                if (match && KEY_MAP[match[1].trim()]) {
                    currentKey = KEY_MAP[match[1].trim()];
                    data[currentKey] = match[2].trim();
                } else if (currentKey) {
                    data[currentKey] = (data[currentKey] ? data[currentKey] + '\n' : '') + line.trim();
                }
            });

            // Construct card object
            const cardId = data['é¡¹ç›®ç¼–å·'] || 'IMP-' + Date.now() + '-' + i;
            newCards.push({
                id: cardId,
                cardId: cardId,
                title: data['é¡¹ç›®åç§°'] || file.name.replace('.md', ''),
                rawText: text,
                data: data,
                isVisible: true,
                updatedAt: new Date().toISOString()
            });
        }

        // Merge with existing cards (update if exists, append if new)
        const updatedCards = [...cards];
        newCards.forEach(nc => {
            const idx = updatedCards.findIndex(c => c.cardId === nc.cardId);
            if (idx >= 0) {
                updatedCards[idx] = { ...updatedCards[idx], ...nc };
            } else {
                updatedCards.push(nc);
            }
        });

        writeCards(updatedCards);
        setCards(updatedCards);
        alert(`å·²å¯¼å…¥ ${newCards.length} ä¸ªé¡¹ç›®å¡ç‰‡`);
      };

      const toggleVisibility = (id) => {
          const next = cards.map(c => {
              if (c.id === id) return { ...c, isVisible: !c.isVisible };
              return c;
          });
          writeCards(next);
          setCards(next);
      };
      const deleteCard = (id) => {
        if (!window.confirm('ç¡®å®šåˆ é™¤è¯¥é¡¹ç›®å¡ç‰‡å—ï¼Ÿ')) return;
        const next = cards.filter(c => c.id !== id);
        writeCards(next);
        setCards(next);
      };
      const duplicateCard = (id) => { const src = cards.find(c => c.id === id); if (!src) return; const copy = { ...src, id: `CARD-${Date.now()}`, cardId: `${src.cardId || ''}-COPY`, updatedAt: new Date().toISOString() }; const next = [...cards, copy]; writeCards(next); setCards(next); };
      
      const newCard = () => { window.open(`cardv8.html?v=${Date.now()}`, '_blank'); };
      const editCard = (id) => { window.open(`cardv8.html?id=${encodeURIComponent(id)}&v=${Date.now()}`, '_blank'); };

      const findProjectForCard = (cardId) => {
          if (!cardId) return null;
          // æå– 1205-NI è¿™æ ·çš„å‰ç¼€
          const m = cardId.match(/^([^-]+-[^-]+)/);
          if (!m) return null;
          const prefix = m[1].toUpperCase();
          return projects.find(p => `${p.meta.customerNo}-${p.meta.projectNo}`.toUpperCase() === prefix);
      };

      const renderProjectLink = (card) => {
          const p = findProjectForCard(card.cardId);
          if (!p) return null;
          return (
              <button 
                  className="px-2 py-1 border border-indigo-200 text-indigo-600 bg-indigo-50 rounded text-sm hover:bg-indigo-100 flex items-center gap-1"
                  onClick={() => window.location.href=`project_detail.html?id=${p.id}`}
                  title={`å±äºé¡¹ç›®: ${p.meta.name}`}
              >
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                  æ‰€å±é¡¹ç›®
              </button>
          );
      };

      return (
        <div className="max-w-6xl mx-auto p-6">
          <div className="flex items-end justify-between mb-6">
            <div>
              <h1 className="text-3xl font-black">é¡¹ç›®å¡ç‰‡ç®¡ç†</h1>
              <p className="text-sm text-gray-500 flex items-center gap-2">
                  {dataSource === 'server' ? 'ğŸŸ¢ å·²è¿æ¥æœåŠ¡å™¨' : (dataSource === 'local' ? 'ğŸŸ¡ ä½¿ç”¨æœ¬åœ°ç¼“å­˜' : 'âšªï¸ åŠ è½½ä¸­...')}
                  <button className="text-blue-600 hover:underline" onClick={forceReload}>[å¼ºåˆ¶åˆ·æ–°]</button>
                  <span id="sync-status" className="ml-4 font-bold transition-all"></span>
              </p>
            </div>
            <div className="flex items-center gap-2">
              <button 
                className="group flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition-all font-bold" 
                onClick={()=> window.location.href='projects.html'}
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="group-hover:scale-110 transition-transform">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="3" y1="9" x2="21" y2="9"/>
                </svg>
                é¡¹ç›®çœ‹æ¿
              </button>
              <button className="px-3 py-2 border rounded-lg hover:bg-gray-50 text-gray-600 font-medium" onClick={() => setShowAIConfig(true)}>AI é…ç½®</button>
              <button className="px-3 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 font-bold" onClick={newCard}>æ–°å»ºå¡ç‰‡</button>
              <button className="px-3 py-2 border rounded-lg hover:bg-gray-50 text-gray-600 font-medium" onClick={()=> window.open('project_timeline.html', '_blank')}>æ—¶é—´è¡¨</button>
            </div>
          </div>

          <div className="flex flex-col gap-4 mb-6 bg-white p-4 rounded border shadow-sm">
            <div className="flex items-center justify-between">
                <input className="w-96 p-2 border rounded" placeholder="æœç´¢ï¼ˆå¡å·/é¡¹ç›®åç§°ï¼‰" value={q} onChange={(e)=>setQ(e.target.value)} />
                <div className="flex gap-2 flex-wrap justify-end">
                    <div className="flex border rounded overflow-hidden mr-2 shrink-0">
                        <button 
                            className={`px-3 py-2 ${viewMode==='grid'?'bg-gray-100 text-blue-600 font-bold shadow-inner':'hover:bg-gray-50'}`} 
                            onClick={()=>setViewMode('grid')} 
                            title="å¡ç‰‡è§†å›¾"
                        >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                        </button>
                        <button 
                            className={`px-3 py-2 ${viewMode==='list'?'bg-gray-100 text-blue-600 font-bold shadow-inner':'hover:bg-gray-50'}`} 
                            onClick={()=>setViewMode('list')} 
                            title="åˆ—è¡¨è§†å›¾"
                        >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                        </button>
                    </div>
                    <label className="px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 flex items-center gap-1 whitespace-nowrap">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        å¯¼å…¥ JSON
                        <input type="file" accept="application/json" className="hidden" onChange={(e)=>importJSON(e.target.files?.[0])} />
                    </label>
                    <label className="px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 flex items-center gap-1 whitespace-nowrap">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                        å¯¼å…¥ MD
                        <input type="file" accept=".md" multiple className="hidden" onChange={(e)=>importMarkdown(e.target.files)} />
                    </label>
                    <button className="px-3 py-2 border rounded flex items-center gap-1 whitespace-nowrap" onClick={exportMarkdown}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        å¯¼å‡º Markdown
                    </button>
                    <button className="px-3 py-2 border rounded flex items-center gap-1 whitespace-nowrap" onClick={calculateBudget}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        é¢„ç®—ç»Ÿè®¡
                    </button>
                    <button className="px-3 py-2 border rounded whitespace-nowrap" onClick={exportJSON}>å¤‡ä»½ JSON</button>
                </div>
            </div>
            {selectedIds.size > 0 && (
                <div className="text-sm bg-blue-50 text-blue-800 px-3 py-2 rounded flex items-center justify-between">
                    <span>å·²é€‰æ‹© {selectedIds.size} ä¸ªé¡¹ç›®</span>
                    <button className="text-blue-600 hover:underline" onClick={() => setSelectedIds(new Set())}>å–æ¶ˆé€‰æ‹©</button>
                </div>
            )}
          </div>

          {filtered.length === 0 ? (
            <div className="p-8 text-center text-gray-500 border rounded bg-white">æš‚æ— å¡ç‰‡ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ–°å»ºå¡ç‰‡â€ã€‚</div>
          ) : (
            <>
                <div className="flex items-center gap-2 mb-2 px-4">
                    <input type="checkbox" 
                        checked={filtered.length > 0 && selectedIds.size === filtered.length}
                        onChange={toggleSelectAll}
                        className="w-4 h-4 rounded border-gray-300"
                    />
                    <span className="text-sm text-gray-500">å…¨é€‰</span>
                </div>
                
                {viewMode === 'grid' ? (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {filtered.map(c => (
                        <div key={c.id} className={`p-4 bg-white border rounded shadow-sm flex flex-col gap-2 transition-all ${selectedIds.has(c.id) ? 'ring-2 ring-blue-500 border-blue-500 bg-blue-50/10' : ''}`}>
                        <div className="flex items-start gap-3">
                            <input 
                                type="checkbox" 
                                className="mt-1.5 w-4 h-4 rounded border-gray-300"
                                checked={selectedIds.has(c.id)}
                                onChange={() => toggleSelect(c.id)}
                            />
                            <div className="flex-1" onClick={() => toggleSelect(c.id)}>
                                <div className="flex items-center justify-between cursor-pointer">
                                    <div className="font-semibold">{c.cardId || c.id}</div>
                                    <div className="text-[11px] text-gray-500">{new Date(c.updatedAt || Date.now()).toLocaleString()}</div>
                                </div>
                                <div className="text-gray-600 cursor-pointer">{c.title || 'æœªå‘½åé¡¹ç›®'}</div>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 mt-2 pl-7">
                            <button className="px-2 py-1 bg-blue-600 text-white rounded text-sm" onClick={()=>editCard(c.id)}>ç¼–è¾‘</button>
                            {renderProjectLink(c)}
                            <button 
                                className={`px-2 py-1 border rounded text-sm flex items-center gap-1 ${c.isVisible !== false ? 'text-green-600 bg-green-50 border-green-200' : 'text-gray-400 bg-gray-50'}`}
                                onClick={()=>toggleVisibility(c.id)}
                                title={c.isVisible !== false ? "å·²å¯ç”¨ï¼šæ˜¾ç¤ºåœ¨æ—¶é—´è¡¨ä¸­" : "å·²ç¦ç”¨ï¼šä¸æ˜¾ç¤ºåœ¨æ—¶é—´è¡¨ä¸­"}
                            >
                                {c.isVisible !== false ? 'âœ… å¯ç”¨' : 'ğŸš« ç¦ç”¨'}
                            </button>
                            <button className="px-2 py-1 border rounded text-sm" onClick={()=>duplicateCard(c.id)}>å¤åˆ¶</button>
                            <button className="px-2 py-1 border rounded text-sm hover:bg-red-50 hover:text-red-600" onClick={()=>deleteCard(c.id)}>åˆ é™¤</button>
                        </div>
                        </div>
                    ))}
                    </div>
                ) : (
                    <div className="bg-white border rounded shadow-sm overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-gray-600 border-b">
                                <tr>
                                    <th className="p-3 w-10"></th>
                                    <th className="p-3">çŠ¶æ€</th>
                                    <th className="p-3">é¡¹ç›®ç¼–å·</th>
                                    <th className="p-3">é¡¹ç›®åç§°</th>
                                    <th className="p-3">æ›´æ–°æ—¶é—´</th>
                                    <th className="p-3 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {filtered.map(c => (
                                    <tr key={c.id} className={`hover:bg-gray-50 ${selectedIds.has(c.id) ? 'bg-blue-50/30' : ''}`}>
                                        <td className="p-3">
                                            <input 
                                                type="checkbox" 
                                                className="w-4 h-4 rounded border-gray-300"
                                                checked={selectedIds.has(c.id)}
                                                onChange={() => toggleSelect(c.id)}
                                            />
                                        </td>
                                        <td className="p-3">
                                            <button 
                                                onClick={()=>toggleVisibility(c.id)}
                                                className={`text-xs px-2 py-0.5 rounded border ${c.isVisible !== false ? 'bg-green-100 text-green-700 border-green-200' : 'bg-gray-100 text-gray-500 border-gray-200'}`}
                                            >
                                                {c.isVisible !== false ? 'å¯ç”¨' : 'ç¦ç”¨'}
                                            </button>
                                        </td>
                                        <td className="p-3 font-mono text-gray-600">{c.cardId || '-'}</td>
                                        <td className="p-3 font-medium cursor-pointer text-blue-600 hover:underline" onClick={()=>editCard(c.id)}>
                                            {c.title || 'æœªå‘½åé¡¹ç›®'}
                                        </td>
                                        <td className="p-3 text-gray-500 text-xs">{new Date(c.updatedAt || Date.now()).toLocaleString()}</td>
                                        <td className="p-3 text-right space-x-2 flex justify-end items-center">
                                            {renderProjectLink(c)}
                                            <button className="text-blue-600 hover:underline" onClick={()=>editCard(c.id)}>ç¼–è¾‘</button>
                                            <button className="text-gray-600 hover:underline" onClick={()=>duplicateCard(c.id)}>å¤åˆ¶</button>
                                            <button className="text-red-600 hover:underline" onClick={()=>deleteCard(c.id)}>åˆ é™¤</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </>
          )}
          {showBudgetModal && <BudgetModal isOpen={showBudgetModal} onClose={()=>setShowBudgetModal(false)} cards={cards} />}
          {showAIConfig && <AIConfigModal isOpen={showAIConfig} onClose={()=>setShowAIConfig(false)} />}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
