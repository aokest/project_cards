<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目看板 | 项目管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f8fafc; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-4">
                    <div class="flex-shrink-0 flex items-center gap-2 text-blue-600 font-black text-xl tracking-tight">
                        <i data-lucide="layout-grid"></i>
                        PROJECT HUB
                    </div>
                    <div class="hidden md:flex ml-10 space-x-8">
                        <a href="projects.html" class="border-b-2 border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 text-sm font-medium">项目看板</a>
                        <a href="project_timeline.html" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 text-sm font-medium">全局时间表</a>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="openSettingsModal('ai')" class="text-gray-500 hover:text-gray-700 p-2 rounded-lg transition-colors" title="系统设置">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                    <button onclick="openCreateModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors flex items-center gap-2 shadow-sm shadow-blue-200">
                        <i data-lucide="plus" class="w-4 h-4"></i> 新建项目
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-4 mb-8">
            <div class="bg-white overflow-hidden shadow rounded-xl border border-gray-100">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-gray-500 truncate">项目总数</dt>
                    <dd class="mt-1 text-3xl font-semibold text-gray-900" id="stat-total">0</dd>
                </div>
            </div>
            <div class="bg-white overflow-hidden shadow rounded-xl border border-gray-100">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-gray-500 truncate">进行中</dt>
                    <dd class="mt-1 text-3xl font-semibold text-green-600" id="stat-active">0</dd>
                </div>
            </div>
            <div class="bg-white overflow-hidden shadow rounded-xl border border-gray-100">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-gray-500 truncate">总预算 (CNY)</dt>
                    <dd class="mt-1 text-3xl font-semibold text-blue-600" id="stat-budget">¥0</dd>
                </div>
            </div>
            <div class="bg-white overflow-hidden shadow rounded-xl border border-gray-100">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-gray-500 truncate">关联卡片</dt>
                    <dd class="mt-1 text-3xl font-semibold text-purple-600" id="stat-cards">0</dd>
                </div>
            </div>
        </div>

        <!-- Filter & Search Bar (Simplified) -->
        <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-4 flex-1">
                    <div class="relative flex-1 max-w-lg">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="search" class="text-gray-400 w-5 h-5"></i>
                        </div>
                        <input type="text" id="search-input" oninput="renderProjects()" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="搜索项目名称、编号、客户...">
                    </div>
                    <select id="status-filter" onchange="renderProjects()" class="pl-3 pr-10 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">全部状态</option>
                        <option value="active">进行中</option>
                        <option value="planning">规划中</option>
                        <option value="completed">已完成</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <span id="loading-status">正在加载数据...</span>
                </div>
            </div>
        </div>

        <!-- Project Grid -->
        <div id="project-grid" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
            <!-- Projects will be rendered here -->
        </div>
    </main>

    <!-- Global Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[600px] flex overflow-hidden">
            <!-- Sidebar -->
            <div class="w-64 bg-gray-50 border-r border-gray-200 p-4 flex flex-col gap-2">
                <h3 class="text-lg font-bold text-gray-900 px-3 mb-2">系统设置</h3>
                <button onclick="switchTab('ai')" id="tab-btn-ai" class="text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-blue-100 text-blue-700">
                    <div class="flex items-center gap-2">
                        <i data-lucide="bot" class="w-4 h-4"></i> AI 模型配置
                    </div>
                </button>
                <button onclick="switchTab('backup')" id="tab-btn-backup" class="text-left px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">
                    <div class="flex items-center gap-2">
                        <i data-lucide="database" class="w-4 h-4"></i> 数据备份与恢复
                    </div>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 flex flex-col min-w-0">
                <div class="flex justify-between items-center p-6 border-b border-gray-100">
                    <h3 class="text-xl font-bold text-gray-900" id="settings-title">AI 模型配置</h3>
                    <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-500 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 custom-scroll relative">
                    <!-- Tab: AI Settings -->
                    <div id="tab-content-ai" class="space-y-6">
                        <div class="flex justify-between items-center mb-4">
                            <div class="text-sm text-gray-500">配置多个 AI 模型，并选择一个作为当前激活模型。</div>
                            <button onclick="addNewProfile()" class="text-sm bg-green-50 text-green-600 px-3 py-1.5 rounded-lg hover:bg-green-100 border border-green-200 font-medium flex items-center gap-1">
                                <i data-lucide="plus" class="w-3 h-3"></i> 新增模型
                            </button>
                        </div>
                        
                        <div id="ai-profiles-list" class="space-y-4">
                            <!-- Profiles rendered here -->
                        </div>
                    </div>

                    <!-- Tab: Backup -->
                    <div id="tab-content-backup" class="hidden space-y-8">
                        <!-- Backup Section -->
                        <div class="bg-blue-50 border border-blue-100 rounded-xl p-6">
                            <h4 class="font-bold text-blue-900 flex items-center gap-2 mb-2">
                                <i data-lucide="download-cloud" class="w-5 h-5"></i> 数据备份
                            </h4>
                            <p class="text-sm text-blue-700 mb-4">将所有项目、卡片数据及系统配置打包下载到本地。</p>
                            
                            <div class="space-y-2 mb-4">
                                <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                                    <input type="checkbox" id="backup-projects" checked class="rounded text-blue-600 focus:ring-blue-500">
                                    包含项目列表
                                </label>
                                <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                                    <input type="checkbox" id="backup-cards" checked class="rounded text-blue-600 focus:ring-blue-500">
                                    包含所有关联卡片
                                </label>
                                <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                                    <input type="checkbox" id="backup-config" checked class="rounded text-blue-600 focus:ring-blue-500">
                                    包含 AI 配置信息
                                </label>
                            </div>

                            <button onclick="performBackup()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 shadow-sm flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> 立即备份数据
                            </button>
                        </div>

                        <!-- Restore Section -->
                        <div class="bg-orange-50 border border-orange-100 rounded-xl p-6">
                            <h4 class="font-bold text-orange-900 flex items-center gap-2 mb-2">
                                <i data-lucide="upload-cloud" class="w-5 h-5"></i> 数据恢复/导入
                            </h4>
                            <p class="text-sm text-orange-700 mb-4">从备份文件恢复数据。注意：同名 ID 的数据将被覆盖。</p>
                            
                            <div class="flex items-center gap-3">
                                <input type="file" id="restore-file" accept=".json" class="block w-full text-sm text-slate-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-lg file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-orange-100 file:text-orange-700
                                  hover:file:bg-orange-200
                                "/>
                                <button onclick="performRestore()" class="bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-orange-700 shadow-sm whitespace-nowrap flex items-center gap-2">
                                    <i data-lucide="refresh-ccw" class="w-4 h-4"></i> 导入并恢复
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div id="create-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all">
            <div class="flex justify-between items-center p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold text-gray-900">新建项目</h3>
                <button onclick="closeCreateModal()" class="text-gray-400 hover:text-gray-500 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">项目名称 *</label>
                        <input type="text" id="p-name" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">项目编号 *</label>
                        <input type="text" id="p-no" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border" placeholder="PROJ-2024-001">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">客户名称</label>
                        <input type="text" id="p-customer" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">客户编号</label>
                        <input type="text" id="p-customer-no" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border" placeholder="CUST-001">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">项目描述</label>
                    <textarea id="p-desc" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border"></textarea>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">预算收入 (元)</label>
                        <input type="number" id="p-budget" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">状态</label>
                        <select id="p-status" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                            <option value="planning">规划中</option>
                            <option value="active" selected>进行中</option>
                            <option value="completed">已完成</option>
                            <option value="suspended">暂停</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">负责人</label>
                        <input type="text" id="p-manager" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-100 bg-gray-50 rounded-b-xl flex justify-end gap-3">
                <button onclick="closeCreateModal()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">取消</button>
                <button onclick="submitCreateProject()" class="px-4 py-2 bg-blue-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">创建项目</button>
            </div>
        </div>
    </div>

    <script>
        // Core Data
        let projects = [];
        let cards = [];

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            lucide.createIcons();
        });

        // Enhanced Data Loading with Status
        async function loadData() {
            const statusEl = document.getElementById('loading-status');
            
            try {
                statusEl.textContent = '正在连接服务器...';
                
                // Fetch Projects
                const pRes = await fetch('/api/projects');
                if (!pRes.ok) throw new Error('Projects API failed');
                projects = await pRes.json();
                
                statusEl.textContent = '正在加载卡片数据...';
                
                // Fetch Cards
                const cRes = await fetch('/api/cards');
                if (!cRes.ok) throw new Error('Cards API failed');
                cards = await cRes.json();
                
                statusEl.textContent = `已加载 ${projects.length} 个项目，${cards.length} 张卡片`;
                
                renderProjects();
                updateStats();
                lucide.createIcons();
                
            } catch (error) {
                console.error("Failed to load data:", error);
                statusEl.textContent = '数据加载失败';
                statusEl.className = 'text-sm text-red-600';
                
                document.getElementById('project-grid').innerHTML = `
                    <div class="col-span-full text-center py-10">
                        <div class="text-red-500 mb-2">
                            <i data-lucide="alert-circle" class="w-12 h-12 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">数据加载失败</h3>
                        <p class="text-gray-500 mb-4">无法连接到后端服务，请检查服务器是否正常运行</p>
                        <button onclick="loadData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                            重新加载
                        </button>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // Render Projects Grid
        function renderProjects() {
            const grid = document.getElementById('project-grid');
            const search = document.getElementById('search-input').value.toLowerCase();
            const status = document.getElementById('status-filter').value;

            const filtered = projects.filter(p => {
                const matchSearch = (p.meta?.name || '').toLowerCase().includes(search) || 
                                  (p.meta?.projectNo || '').toLowerCase().includes(search) ||
                                  (p.meta?.customer || '').toLowerCase().includes(search);
                const matchStatus = status === 'all' || p.meta?.status === status;
                return matchSearch && matchStatus;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400">
                        <i data-lucide="folder-open" class="w-16 h-16 mb-4 text-gray-200"></i>
                        <p class="text-lg font-medium">没有找到相关项目</p>
                        <p class="text-sm mt-2">尝试调整搜索条件或新建一个项目</p>
                    </div>
                `;
            } else {
                grid.innerHTML = filtered.map(p => createProjectCard(p)).join('');
            }
            lucide.createIcons();
        }

        function createProjectCard(p) {
            const statusColors = {
                'active': 'bg-green-100 text-green-800',
                'planning': 'bg-blue-100 text-blue-800',
                'completed': 'bg-gray-100 text-gray-800',
                'suspended': 'bg-red-100 text-red-800'
            };
            const statusLabels = {
                'active': '进行中',
                'planning': '规划中',
                'completed': '已完成',
                'suspended': '暂停'
            };

            const budget = p.finance?.budgetIncome ? `¥${parseInt(p.finance.budgetIncome).toLocaleString()}` : '-';
            const manager = p.meta?.manager || (p.team?.sales?.[0] || p.team?.product?.[0] || '未指定');
            const displayStatus = statusLabels[p.meta.status] || p.meta.status || '未设置';
            const displayStatusColor = statusColors[p.meta.status] || 'bg-gray-100 text-gray-800';

            // Calculate progress (mock logic or based on cards)
            const relatedCards = cards.filter(c => c.cardId && c.cardId.startsWith(`${p.meta.customerNo}-${p.meta.projectNo}`));
            const cardCount = relatedCards.length;

            return `
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all cursor-pointer group card-hover relative overflow-hidden" onclick="window.location.href='project_detail.html?id=${p.id}'">
                    <div class="absolute top-0 left-0 w-1 h-full ${p.meta.status === 'active' ? 'bg-green-500' : 'bg-gray-300'}"></div>
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900 group-hover:text-blue-600 transition-colors line-clamp-1">${p.meta.name}</h3>
                                <p class="text-xs text-gray-500 font-mono mt-1">${p.meta.projectNo}</p>
                            </div>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColors[p.meta.status] || 'bg-gray-100 text-gray-800'}">
                                ${statusLabels[p.meta.status] || p.meta.status}
                            </span>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-6 line-clamp-2 h-10">${p.meta.description || '暂无描述...'}</p>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm border-t border-gray-100 pt-4">
                            <div>
                                <span class="block text-xs text-gray-400 mb-1">客户</span>
                                <span class="font-medium text-gray-700 truncate block" title="${p.meta.customer || '-'}">${p.meta.customer || '-'}</span>
                            </div>
                            <div>
                                <span class="block text-xs text-gray-400 mb-1">负责人</span>
                                <div class="flex items-center gap-1">
                                    <div class="w-4 h-4 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-[10px] font-bold">
                                        ${manager.charAt(0)}
                                    </div>
                                    <span class="font-medium text-gray-700 truncate" title="${manager}">${manager}</span>
                                </div>
                            </div>
                            <div>
                                <span class="block text-xs text-gray-400 mb-1">预算</span>
                                <span class="font-medium text-gray-900">${budget}</span>
                            </div>
                            <div>
                                <span class="block text-xs text-gray-400 mb-1">关联卡片</span>
                                <span class="font-medium text-indigo-600 flex items-center gap-1">
                                    <i data-lucide="layers" class="w-3 h-3"></i> ${cardCount}
                                </span>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-gray-100 flex justify-end">
                             <button onclick="event.stopPropagation(); openEditModal('${p.id}')" class="text-xs text-blue-600 hover:text-blue-800 font-medium px-2 py-1 rounded hover:bg-blue-50 transition-colors">
                                编辑信息
                             </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Stats
        function updateStats() {
            document.getElementById('stat-total').innerText = projects.length;
            document.getElementById('stat-active').innerText = projects.filter(p => p.meta?.status === 'active').length;
            
            let totalBudget = 0;
            projects.forEach(p => {
                if (p.finance?.budgetIncome) totalBudget += parseFloat(p.finance.budgetIncome);
            });
            document.getElementById('stat-budget').innerText = `¥${(totalBudget/10000).toFixed(1)}w`;
            
            document.getElementById('stat-cards').innerText = cards.length;
        }

        // Global Settings & AI Functions
        let aiConfig = { profiles: [], activeId: null };
        const AI_CONFIG_KEY = 'ai_config_v2';

        function initSettings() {
            // Migration
            const oldConfig = localStorage.getItem('ai_config');
            const newConfig = localStorage.getItem(AI_CONFIG_KEY);
            
            if (oldConfig && !newConfig) {
                try {
                    const old = JSON.parse(oldConfig);
                    if (old.apiKey) {
                        const profileId = Date.now().toString();
                        const migrated = {
                            profiles: [{
                                id: profileId,
                                name: '默认配置 (迁移)',
                                apiKey: old.apiKey,
                                baseUrl: old.baseUrl || 'https://api.openai.com/v1',
                                model: old.model || 'gpt-3.5-turbo'
                            }],
                            activeId: profileId
                        };
                        localStorage.setItem(AI_CONFIG_KEY, JSON.stringify(migrated));
                        localStorage.removeItem('ai_config'); // Clean up
                    }
                } catch(e) {}
            }
            
            // Load
            const saved = localStorage.getItem(AI_CONFIG_KEY);
            if (saved) {
                try { aiConfig = JSON.parse(saved); } catch(e) { console.error(e); }
            }
        }

        function openSettingsModal(tab = 'ai') {
            initSettings(); // Reload to be safe
            document.getElementById('settings-modal').classList.remove('hidden');
            switchTab(tab);
            if (tab === 'ai') renderAIProfiles();
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function switchTab(tab) {
            // Buttons
            document.querySelectorAll('[id^="tab-btn-"]').forEach(btn => {
                btn.className = "text-left px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors";
            });
            const activeBtn = document.getElementById(`tab-btn-${tab}`);
            activeBtn.className = "text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-blue-100 text-blue-700";
            
            // Content
            document.querySelectorAll('[id^="tab-content-"]').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab-content-${tab}`).classList.remove('hidden');
            
            // Title
            const titles = { 'ai': 'AI 模型配置', 'backup': '数据备份与恢复' };
            document.getElementById('settings-title').innerText = titles[tab];
        }

        // --- AI Profiles Logic ---

        function renderAIProfiles() {
            const container = document.getElementById('ai-profiles-list');
            if (aiConfig.profiles.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 py-8">暂无配置，请点击“新增模型”添加</div>`;
                return;
            }

            container.innerHTML = aiConfig.profiles.map(p => {
                const isActive = p.id === aiConfig.activeId;
                return `
                    <div class="border rounded-xl p-4 transition-all ${isActive ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-gray-200 hover:border-blue-300 bg-white'}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-2">
                                <div class="font-bold text-gray-900">${p.name}</div>
                                ${isActive ? '<span class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">使用中</span>' : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                ${!isActive ? `<button onclick="activateProfile('${p.id}')" class="text-xs text-blue-600 hover:underline">设为使用</button>` : ''}
                                <button onclick="deleteProfile('${p.id}')" class="text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1">Base URL</label>
                                <input type="text" value="${p.baseUrl}" onchange="updateProfile('${p.id}', 'baseUrl', this.value)" class="w-full text-xs p-1.5 border rounded bg-white/50 focus:bg-white focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1">Model Name</label>
                                <input type="text" value="${p.model}" onchange="updateProfile('${p.id}', 'model', this.value)" class="w-full text-xs p-1.5 border rounded bg-white/50 focus:bg-white focus:border-blue-500 outline-none">
                            </div>
                            <div class="col-span-2">
                                <label class="text-xs font-bold text-gray-500 block mb-1">API Key</label>
                                <div class="flex gap-2">
                                    <input type="password" value="${p.apiKey}" onchange="updateProfile('${p.id}', 'apiKey', this.value)" class="flex-1 text-xs p-1.5 border rounded bg-white/50 focus:bg-white focus:border-blue-500 outline-none" placeholder="sk-...">
                                    <button onclick="validateProfile('${p.id}')" id="btn-val-${p.id}" class="px-3 py-1.5 border rounded text-xs hover:bg-gray-50 text-gray-600 flex items-center gap-1">
                                        <i data-lucide="zap" class="w-3 h-3"></i> 验证
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function addNewProfile() {
            const newId = Date.now().toString();
            aiConfig.profiles.push({
                id: newId,
                name: '新配置 ' + newId.substr(-4),
                apiKey: '',
                baseUrl: 'https://api.openai.com/v1',
                model: 'gpt-3.5-turbo'
            });
            if (!aiConfig.activeId) aiConfig.activeId = newId;
            saveSettings();
            renderAIProfiles();
        }

        function updateProfile(id, field, value) {
            const p = aiConfig.profiles.find(x => x.id === id);
            if (p) {
                p[field] = value;
                saveSettings();
            }
        }

        function deleteProfile(id) {
            if (!confirm('确定删除此配置吗？')) return;
            aiConfig.profiles = aiConfig.profiles.filter(x => x.id !== id);
            if (aiConfig.activeId === id) {
                aiConfig.activeId = aiConfig.profiles.length > 0 ? aiConfig.profiles[0].id : null;
            }
            saveSettings();
            renderAIProfiles();
        }

        function activateProfile(id) {
            aiConfig.activeId = id;
            saveSettings();
            renderAIProfiles();
        }

        function saveSettings() {
            localStorage.setItem(AI_CONFIG_KEY, JSON.stringify(aiConfig));
            // Sync legacy key for other pages that might still use it temporarily (optional, but good for compat)
            if (aiConfig.activeId) {
                const active = aiConfig.profiles.find(p => p.id === aiConfig.activeId);
                if (active) {
                    localStorage.setItem('project_cards_ai_config', JSON.stringify({
                        apiKey: active.apiKey,
                        baseUrl: active.baseUrl,
                        model: active.model
                    }));
                }
            }
        }

        async function validateProfile(id) {
            const p = aiConfig.profiles.find(x => x.id === id);
            if (!p || !p.apiKey) { alert('请先填写 API Key'); return; }
            
            const btn = document.getElementById(`btn-val-${id}`);
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> 测试中...`;
            lucide.createIcons();
            btn.disabled = true;

            try {
                // Simple validation call (using models list or chat completion)
                // Some providers don't support /models, so we try a tiny chat completion
                const res = await fetch(`${p.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${p.apiKey}` },
                    body: JSON.stringify({
                        model: p.model,
                        messages: [{ role: 'user', content: 'Hi' }],
                        max_tokens: 5
                    })
                });
                
                if (res.ok) {
                    btn.innerHTML = `<i data-lucide="check" class="w-3 h-3 text-green-500"></i> 成功`;
                    btn.classList.add('border-green-500', 'bg-green-50');
                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.classList.remove('border-green-500', 'bg-green-50');
                        btn.disabled = false;
                        lucide.createIcons();
                    }, 3000);
                } else {
                    throw new Error(`HTTP ${res.status}`);
                }
            } catch (e) {
                alert('连接失败: ' + e.message);
                btn.innerHTML = `<i data-lucide="x" class="w-3 h-3 text-red-500"></i> 失败`;
                btn.classList.add('border-red-500', 'bg-red-50');
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        // --- Backup & Restore Logic ---

        async function performBackup() {
            const includeProjects = document.getElementById('backup-projects').checked;
            const includeCards = document.getElementById('backup-cards').checked;
            const includeConfig = document.getElementById('backup-config').checked;

            if (!includeProjects && !includeCards && !includeConfig) {
                alert('请至少选择一项要备份的内容');
                return;
            }

            const backupData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                data: {}
            };

            try {
                if (includeProjects) {
                    const res = await fetch('/api/projects');
                    if (res.ok) backupData.data.projects = await res.json();
                }
                if (includeCards) {
                    const res = await fetch('/api/cards');
                    if (res.ok) backupData.data.cards = await res.json();
                }
                if (includeConfig) {
                    backupData.data.aiConfig = localStorage.getItem(AI_CONFIG_KEY);
                }

                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `project_hub_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) {
                alert('备份失败: ' + e.message);
            }
        }

        async function performRestore() {
            const fileInput = document.getElementById('restore-file');
            const file = fileInput.files[0];
            if (!file) { alert('请先选择备份文件'); return; }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (!backup.data) throw new Error('无效的备份文件格式');

                    let msg = '恢复结果：\n';
                    
                    // Restore Config
                    if (backup.data.aiConfig) {
                        localStorage.setItem(AI_CONFIG_KEY, backup.data.aiConfig);
                        msg += '✅ 配置信息已恢复\n';
                        initSettings(); // Refresh memory
                    }

                    // Restore Projects
                    if (backup.data.projects) {
                        const res = await fetch('/api/projects', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(backup.data.projects)
                        });
                        if (res.ok) msg += `✅ 已恢复 ${backup.data.projects.length} 个项目\n`;
                    }

                    // Restore Cards
                    if (backup.data.cards) {
                        const res = await fetch('/api/cards', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(backup.data.cards)
                        });
                        if (res.ok) msg += `✅ 已恢复 ${backup.data.cards.length} 张卡片\n`;
                    }

                    alert(msg);
                    location.reload();

                } catch (err) {
                    alert('文件解析失败: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // Edit Project Function
        let currentEditProjectId = null;

        function openEditModal(projectId) {
            currentEditProjectId = projectId;
            const p = projects.find(proj => proj.id === projectId);
            if (!p) return;

            // Fill form
            document.getElementById('p-name').value = p.meta.name || '';
            document.getElementById('p-no').value = p.meta.projectNo || '';
            document.getElementById('p-customer').value = p.meta.customer || '';
            document.getElementById('p-customer-no').value = p.meta.customerNo || '';
            document.getElementById('p-desc').value = p.meta.description || '';
            document.getElementById('p-status').value = p.meta.status || 'planning';
            document.getElementById('p-manager').value = p.meta.manager || '';
            document.getElementById('p-budget').value = p.finance?.budgetIncome || '';

            // Change modal title and button
            document.querySelector('#create-modal h3').textContent = '编辑项目';
            const submitBtn = document.querySelector('#create-modal button[onclick="submitCreateProject()"]');
            if(submitBtn) {
                submitBtn.textContent = '保存变更';
                submitBtn.onclick = submitEditProject;
            } else {
                 // Try finding by text if onclick matches
                 const btns = document.querySelectorAll('#create-modal button');
                 btns.forEach(b => {
                     if(b.textContent.includes('创建项目')) {
                         b.textContent = '保存变更';
                         b.onclick = submitEditProject;
                     }
                 });
            }

            openCreateModal();
        }

        async function submitEditProject() {
            if (!currentEditProjectId) return;
            
            const pIndex = projects.findIndex(p => p.id === currentEditProjectId);
            if (pIndex === -1) return;

            const updatedMeta = {
                ...projects[pIndex].meta,
                name: document.getElementById('p-name').value,
                projectNo: document.getElementById('p-no').value,
                customer: document.getElementById('p-customer').value,
                customerNo: document.getElementById('p-customer-no').value,
                description: document.getElementById('p-desc').value,
                status: document.getElementById('p-status').value,
                manager: document.getElementById('p-manager').value,
            };

            const updatedFinance = {
                ...projects[pIndex].finance,
                budgetIncome: document.getElementById('p-budget').value
            };

            projects[pIndex] = {
                ...projects[pIndex],
                meta: updatedMeta,
                finance: updatedFinance
            };

            // Reset Modal State
            document.querySelector('#create-modal h3').textContent = '新建项目';
            const submitBtn = document.querySelector('#create-modal button'); 
            // We need to find the specific button again safely
             const btns = document.querySelectorAll('#create-modal button');
             btns.forEach(b => {
                 if(b.textContent.includes('保存变更')) {
                     b.textContent = '创建项目';
                     b.onclick = submitCreateProject;
                 }
             });

            currentEditProjectId = null;

            // Save to server
            try {
                await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projects)
                });
                closeCreateModal();
                renderProjects();
                updateStats();
            } catch (e) {
                alert('保存失败: ' + e.message);
            }
        }

        // Create Project Functions
        function openCreateModal() {
            if (!currentEditProjectId) {
                // Clear form if opening for create
                document.getElementById('p-name').value = '';
                document.getElementById('p-no').value = '';
                document.getElementById('p-customer').value = '';
                document.getElementById('p-customer-no').value = '';
                document.getElementById('p-desc').value = '';
                document.getElementById('p-status').value = 'active';
                document.getElementById('p-manager').value = '';
                document.getElementById('p-budget').value = '';
                
                document.querySelector('#create-modal h3').textContent = '新建项目';
                 const btns = document.querySelectorAll('#create-modal button');
                 btns.forEach(b => {
                     if(b.textContent.includes('保存变更')) {
                         b.textContent = '创建项目';
                         b.onclick = submitCreateProject;
                     }
                 });
            }
            document.getElementById('create-modal').classList.remove('hidden');
        }

        function closeCreateModal() {
            document.getElementById('create-modal').classList.add('hidden');
        }

        async function submitCreateProject() {
            const newProject = {
                id: Date.now().toString(),
                meta: {
                    name: document.getElementById('p-name').value,
                    projectNo: document.getElementById('p-no').value,
                    customer: document.getElementById('p-customer').value,
                    customerNo: document.getElementById('p-customer-no').value,
                    description: document.getElementById('p-desc').value,
                    status: document.getElementById('p-status').value,
                    manager: document.getElementById('p-manager').value,
                    startDate: new Date().toISOString().split('T')[0]
                },
                finance: {
                    budgetIncome: document.getElementById('p-budget').value
                },
                milestones: []
            };

            if (!newProject.meta.name || !newProject.meta.projectNo) {
                alert('请填写项目名称和编号');
                return;
            }

            projects.push(newProject);
            
            // Save to server
            try {
                await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projects)
                });
                closeCreateModal();
                renderProjects();
                updateStats();
            } catch (e) {
                alert('保存失败: ' + e.message);
            }
        }
    </script>
</body>
</html>