<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目看板 | 项目管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f8fafc; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-4">
                    <div class="flex-shrink-0 flex items-center gap-2 text-blue-600 font-black text-xl tracking-tight">
                        <i data-lucide="layout-grid"></i>
                        PROJECT HUB
                    </div>
                    <div class="hidden md:flex ml-10 space-x-8">
                        <a href="projects.html" class="border-b-2 border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 text-sm font-medium">项目看板</a>
                        <a href="index.html" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 text-sm font-medium">卡片列表 (旧版)</a>
                        <a href="project_timeline.html" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 text-sm font-medium">全局时间表</a>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="openAIModal()" class="p-2 text-gray-400 hover:text-blue-600 transition-colors" title="AI 设置"><i data-lucide="bot" class="w-5 h-5"></i></button>
                    <button onclick="window.location.reload()" class="p-2 text-gray-400 hover:text-gray-500"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
                    <button onclick="openCreateModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors flex items-center gap-2 shadow-sm shadow-blue-200">
                        <i data-lucide="plus" class="w-4 h-4"></i> 新建项目
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-4 mb-8">
            <div class="bg-white overflow-hidden shadow rounded-xl border border-gray-100">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-gray-500 truncate">项目总数</dt>
                    <dd class="mt-1 text-3xl font-semibold text-gray-900" id="stat-total">0</dd>
                </div>
            </div>
            <div class="bg-white overflow-hidden shadow rounded-xl border border-gray-100">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-gray-500 truncate">进行中</dt>
                    <dd class="mt-1 text-3xl font-semibold text-green-600" id="stat-active">0</dd>
                </div>
            </div>
            <div class="bg-white overflow-hidden shadow rounded-xl border border-gray-100">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-gray-500 truncate">总预算 (CNY)</dt>
                    <dd class="mt-1 text-3xl font-semibold text-blue-600" id="stat-budget">¥0</dd>
                </div>
            </div>
            <div class="bg-white overflow-hidden shadow rounded-xl border border-gray-100">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-gray-500 truncate">关联卡片</dt>
                    <dd class="mt-1 text-3xl font-semibold text-purple-600" id="stat-cards">0</dd>
                </div>
            </div>
        </div>

        <!-- Filter & Search -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div class="relative w-full sm:w-96">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-lucide="search" class="text-gray-400 w-5 h-5"></i>
                </div>
                <input type="text" id="search-input" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out" placeholder="搜索项目名称、编号、客户...">
            </div>
            <div class="flex gap-2">
                <select id="status-filter" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    <option value="all">全部状态</option>
                    <option value="active">进行中</option>
                    <option value="planning">规划中</option>
                    <option value="completed">已完成</option>
                </select>
            </div>
        </div>

        <!-- Project Grid -->
        <div id="project-grid" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
            <!-- Projects will be rendered here -->
            <div class="col-span-full text-center py-20 text-gray-400 flex flex-col items-center">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-2"></i>
                加载数据中...
            </div>
        </div>
    </main>

    <!-- Create Project Modal -->
    <div id="create-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-gray-900">新建项目</h3>
                <button onclick="closeCreateModal()" class="text-gray-400 hover:text-gray-500"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="create-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">客户代号 (Prefix)</label>
                        <input type="text" name="customerNo" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm uppercase" placeholder="例如 1205">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">项目代号</label>
                        <input type="text" name="projectNo" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm uppercase" placeholder="例如 PROJ01">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">项目名称</label>
                    <input type="text" name="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="请输入项目全称">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">合同编号</label>
                        <input type="text" name="contractNo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="可选">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">预算 (万元)</label>
                        <input type="number" name="budget" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="0">
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeCreateModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">取消</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-lg shadow-blue-200">创建</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AI Config Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i data-lucide="bot" class="text-blue-600"></i> AI 全局配置
                </h3>
                <button onclick="closeAIModal()" class="text-gray-400 hover:text-gray-500"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">API URL</label>
                    <input type="text" id="ai-url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="https://api.openai.com/v1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">API Key</label>
                    <input type="password" id="ai-key" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="sk-...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Model Name</label>
                    <input type="text" id="ai-model" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" placeholder="gpt-3.5-turbo">
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-6">
                <button onclick="closeAIModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">取消</button>
                <button onclick="saveAIConfig()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">保存配置</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // Data Store
        let projects = [];
        let cards = [];

        // Fetch Data
        async function loadData() {
            try {
                const [pRes, cRes] = await Promise.all([
                    fetch('/api/projects'),
                    fetch('/api/cards')
                ]);
                projects = await pRes.json();
                cards = await cRes.json();
                renderProjects();
                updateStats();
            } catch (e) {
                console.error("Failed to load data", e);
                document.getElementById('project-grid').innerHTML = `<div class="col-span-full text-center text-red-500">数据加载失败，请检查服务器</div>`;
            }
        }

        // Render Grid
        function renderProjects() {
            const grid = document.getElementById('project-grid');
            const term = document.getElementById('search-input').value.toLowerCase();
            
            const filtered = projects.filter(p => {
                const searchStr = `${p.meta.name} ${p.meta.projectNo} ${p.meta.customerNo} ${p.meta.contractNo}`.toLowerCase();
                return searchStr.includes(term);
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-20 text-gray-400">暂无项目，请点击右上角新建</div>`;
                return;
            }

            grid.innerHTML = filtered.map(p => {
                // Find associated cards count
                const prefix = `${p.meta.customerNo}-${p.meta.projectNo}`;
                const relatedCards = cards.filter(c => (c.cardId || '').startsWith(prefix));
                const progress = relatedCards.length > 0 ? Math.min(100, relatedCards.length * 20) : 0; // Fake progress logic

                return `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 card-hover transition-all cursor-pointer relative group" onclick="window.location.href='project_detail.html?id=${p.id}'">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mb-2">
                                ${p.meta.customerNo}
                            </span>
                            <h3 class="text-lg font-bold text-gray-900 line-clamp-1 group-hover:text-blue-600 transition-colors">${p.meta.name}</h3>
                            <p class="text-sm text-gray-500 font-mono mt-1">${p.meta.contractNo || '无合同编号'}</p>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 group-hover:bg-blue-50 group-hover:text-blue-500 transition-colors">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>关联卡片</span>
                            <span class="font-bold">${relatedCards.length}</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>预算</span>
                            <span class="font-bold">¥${(p.finance?.budgetIncome || 0).toLocaleString()}</span>
                        </div>
                        
                        <div class="pt-2">
                            <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span>完成度估算</span>
                                <span>${progress}%</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-50 flex items-center gap-2 text-xs text-gray-400">
                        <i data-lucide="users" class="w-3 h-3"></i>
                        ${p.team?.sales || '未分配销售'}
                    </div>
                </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = projects.length;
            document.getElementById('stat-active').innerText = projects.length; // TODO: filter active
            
            const totalBudget = projects.reduce((acc, p) => acc + Number(p.finance?.budgetIncome || 0), 0);
            document.getElementById('stat-budget').innerText = `¥${(totalBudget/10000).toFixed(1)}万`;
            
            // Count cards linked to any project
            const linkedCards = cards.filter(c => projects.some(p => (c.cardId || '').startsWith(`${p.meta.customerNo}-${p.meta.projectNo}`)));
            document.getElementById('stat-cards').innerText = linkedCards.length;
        }

        // Modal Logic
        const modal = document.getElementById('create-modal');
        function openCreateModal() { modal.classList.remove('hidden'); }
        function closeCreateModal() { modal.classList.add('hidden'); }

        // AI Config Logic
        const aiModal = document.getElementById('ai-modal');
        function openAIModal() { 
            aiModal.classList.remove('hidden');
            const config = JSON.parse(localStorage.getItem('project_cards_ai_config') || '{}');
            document.getElementById('ai-url').value = config.baseUrl || 'https://api.openai.com/v1';
            document.getElementById('ai-key').value = config.apiKey || '';
            document.getElementById('ai-model').value = config.model || 'gpt-3.5-turbo';
        }
        function closeAIModal() { aiModal.classList.add('hidden'); }
        function saveAIConfig() {
            const config = {
                baseUrl: document.getElementById('ai-url').value,
                apiKey: document.getElementById('ai-key').value,
                model: document.getElementById('ai-model').value
            };
            localStorage.setItem('project_cards_ai_config', JSON.stringify(config));
            closeAIModal();
            alert('AI 配置已保存');
        }

        // Create Project
        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const newProject = {
                id: crypto.randomUUID(),
                meta: {
                    customerNo: formData.get('customerNo').toUpperCase(),
                    projectNo: formData.get('projectNo').toUpperCase(),
                    name: formData.get('name'),
                    contractNo: formData.get('contractNo')
                },
                team: { sales: '', service: '', product: '' },
                finance: { budgetIncome: formData.get('budget') * 10000, budgetCost: 0, currency: 'CNY' },
                timeline: { start: '', end: '' },
                deliverables: [],
                content: { goals: '', scope: '', analysis: '' },
                createdAt: new Date().toISOString()
            };

            const updatedProjects = [...projects, newProject];
            
            try {
                await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedProjects)
                });
                closeCreateModal();
                loadData(); // Refresh
                e.target.reset();
            } catch (err) {
                alert('创建失败: ' + err.message);
            }
        });

        // Search Listener
        document.getElementById('search-input').addEventListener('input', renderProjects);

        // Init
        loadData();
    </script>
</body>
</html>